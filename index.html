<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University of Arusha - Requisition System</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #ffffff;
            color: #2b327a;
            line-height: 1.4;
            font-size: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 24px;
            animation: fadeIn 0.6s ease-out;
            position: relative;
            overflow: hidden;
        }

        .header-top {
            display: none;
        }

        .header-main {
            background: linear-gradient(rgba(30, 58, 138, 0.8), rgba(30, 58, 138, 0.8)), url('https://i.postimg.cc/cHt4C2dZ/151.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            padding: 24px 0;
        }

        .header-main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            position: relative;
            z-index: 2;
        }

        .university-logo {
            width: 48px;
            height: 48px;
            object-fit: contain;
            border-radius: 50%;
            animation: spin 8s linear infinite;
            background: #ffffff;
            padding: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .university-photo {
            width: 60px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .header-text {
            text-align: center;
        }

        .header h1 {
            color: #ffffff;
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0 0 4px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: #e5e7eb;
            font-size: 0.7rem;
            margin: 0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .role-selection {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            animation: slideUp 0.6s ease-out;
        }

        .role-selection h2 {
            color: #2b327a;
            font-size: 0.9rem;
            margin: 0 0 14px 0;
            text-align: center;
            font-weight: 600;
        }

        .role-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .auth-section {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            animation: slideUp 0.6s ease-out;
        }

        .auth-section h3 {
            color: #2b327a;
            font-size: 0.9rem;
            margin: 0 0 14px 0;
            text-align: center;
        }

        .auth-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .user-dropdown {
            position: relative;
            margin-bottom: 20px;
        }

        .dropdown-btn {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #ffffff;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #374151;
        }

        .dropdown-btn:hover {
            border-color: #2b327a;
        }

        .dropdown-arrow {
            transition: transform 0.2s ease;
        }

        .dropdown-arrow.open {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .dropdown-menu.open {
            display: block;
        }

        .dropdown-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 11px;
            color: #374151;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f9fafb;
        }

        .password-input {
            margin-bottom: 20px;
        }

        .login-btn {
            background: #2b327a;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
        }

        .login-btn:hover {
            background: #1e2563;
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .role-btn {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            color: #374151;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            text-align: center;
            font-size: 11px;
        }

        .role-btn:hover {
            border-color: #d4af36;
            background: #fffbeb;
        }

        .role-btn.active {
            background: #2b327a;
            border-color: #2b327a;
            color: #ffffff;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            animation: slideUp 0.6s ease-out;
        }

        .card h3 {
            color: #2b327a;
            font-size: 1rem;
            margin: 0 0 14px 0;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            color: #374151;
            font-weight: 500;
            font-size: 10px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 10px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background: #ffffff;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2b327a;
            box-shadow: 0 0 0 3px rgba(43, 50, 122, 0.1);
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: #9ca3af;
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group input[readonly] {
            background: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }

        .form-group input[readonly]:hover {
            transform: none;
            border-color: #d1d5db;
        }

        .form-group input[type="file"] {
            padding: 6px 10px;
            font-size: 10px;
        }

        .form-group input[type="file"]:hover {
            background: #f9fafb;
        }

        .btn {
            background: #2b327a;
            color: #ffffff;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            background: #1e2563;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 9px;
            width: auto;
            margin-right: 6px;
        }

        .btn-success {
            background: #109747;
        }

        .btn-success:hover {
            background: #0d7a3a;
        }

        .btn-warning {
            background: #d4af36;
            color: #1f2937;
        }

        .btn-warning:hover {
            background: #b8941f;
        }

        .btn-danger {
            background: #dc2626;
            color: #ffffff;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
        }

        .info-card h4 {
            color: #2b327a;
            font-size: 0.8rem;
            margin: 0 0 12px 0;
            font-weight: 600;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-value {
            font-weight: 600;
            color: #2b327a;
        }

        .workflow-section {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            animation: slideUp 0.8s ease-out;
        }

        .workflow-title {
            color: #2b327a;
            font-size: 1rem;
            margin: 0 0 16px 0;
            text-align: center;
            font-weight: 600;
        }

        .workflow-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            position: relative;
        }

        .workflow-steps::before {
            content: '';
            position: absolute;
            top: 22px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: #e5e7eb;
            z-index: 1;
        }

        .step {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            color: #6b7280;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .step.active {
            background: #d4af36;
            border-color: #d4af36;
            color: #ffffff;
            transform: scale(1.1);
        }

        .step.completed {
            background: #109747;
            border-color: #109747;
            color: #ffffff;
        }

        .step-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 0 16px;
        }

        .step-label {
            flex: 1;
            text-align: center;
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            position: relative;
        }

        .requisitions-section {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            animation: slideUp 1s ease-out;
        }

        .requisitions-section h3 {
            color: #2b327a;
            font-size: 1.2rem;
            margin: 0 0 16px 0;
            font-weight: 600;
        }

        .requisition-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .requisition-item:hover {
            border-color: #d4af36;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .req-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .req-id {
            font-weight: 600;
            color: #2b327a;
            font-size: 1rem;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-verified {
            background: #d1fae5;
            color: #065f46;
        }

        .status-authorized {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-approved1 {
            background: #e0e7ff;
            color: #3730a3;
        }

        .status-approved2 {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .status-approved3 {
            background: #dcfce7;
            color: #166534;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .req-details {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .req-actions {
            display: flex;
            gap: 8px;
        }

        .hidden {
            display: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: transparent;
            color: #109747;
            border: 2px solid #109747;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            font-size: 14px;
            font-weight: 500;
        }

        .notification.error {
            background: transparent;
            color: #dc2626;
            border-color: #dc2626;
        }

        .notification.info {
            background: transparent;
            color: #0ea5e9;
            border-color: #0ea5e9;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f4f6;
            border-radius: 50%;
            border-top-color: #2b327a;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .footer-divider {
            height: 2px;
            background: #d4af36;
            margin-top: 24px;
            animation: slideUp 1.2s ease-out;
        }

        .footer {
            background: #2b327a;
            color: #ffffff;
            padding: 20px 0;
            margin-top: 0;
            animation: slideUp 1.4s ease-out;
        }

        .footer-content {
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
            padding: 0 20px;
        }

        .support-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            color: #ffffff;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .phone-icon {
            width: 14px;
            height: 14px;
            color: #ffffff;
        }

        .copyright-info {
            color: #ffffff;
            font-size: 0.65rem;
            line-height: 1.6;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.3s ease-out;
        }

        .modal h3 {
            color: #2b327a;
            font-size: 1.2rem;
            margin: 0 0 16px 0;
            font-weight: 600;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .role-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .workflow-steps {
                flex-direction: column;
                gap: 20px;
            }
            
            .workflow-steps::before {
                display: none;
            }
            
            .step-labels {
                flex-direction: column;
                gap: 20px;
            }

            .header-content {
                flex-direction: column;
                gap: 16px;
            }

            .header-text {
                text-align: center;
            }

            .university-logo {
                width: 40px;
                height: 40px;
            }

            .modal {
                width: 95%;
                margin: 20px;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top"></div>
            <div class="header-main">
                <div class="header-content">
                    <img src="https://i.postimg.cc/YCRyKXW7/uoalogo.png" alt="University of Arusha Logo" class="university-logo" onerror="this.style.display='none';">
                    <div class="header-text">
                        <h1>The University of Arusha</h1>
                        <p>Requisition Management System</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="role-selection" id="role-selection">
            <h2>Select Your Role</h2>
            <div class="role-grid">
                <button class="role-btn" onclick="selectRole('cashier')">Cashier</button>
                <button class="role-btn" onclick="selectRole('chief-accountant')">Chief Accountant</button>
                <button class="role-btn" onclick="selectRole('dfa')">Director of Finance</button>
                <button class="role-btn" onclick="selectRole('dvc-paf')">DVC-PAF</button>
                <button class="role-btn" onclick="selectRole('dvc-a')">DVC-A</button>
                <button class="role-btn" onclick="selectRole('vc')">Vice Chancellor</button>
                <button class="role-btn" onclick="selectRole('admin')">System Admin</button>
            </div>
        </div>

        <div class="auth-section" id="auth-section" style="display: none;">
            <h3>User Authentication</h3>
            <div class="auth-form">
                <div class="user-dropdown">
                    <div class="dropdown-btn" onclick="toggleDropdown()">
                        <span id="selected-user">Select User</span>
                        <span class="dropdown-arrow" id="dropdown-arrow">▼</span>
                    </div>
                    <div class="dropdown-menu" id="dropdown-menu">
                        <!-- Users will be populated here -->
                    </div>
                </div>
                
                <div class="password-input">
                    <input type="password" id="password" placeholder="Enter password" class="form-group input" style="width: 100%; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                </div>
                
                <button class="login-btn" onclick="authenticateUser()" id="login-btn" disabled>
                    <span id="login-btn-text">Login</span>
                </button>
            </div>
        </div>

        <div class="main-grid" id="main-content" style="display: none;">
            <div class="card" id="requisition-form">
                <h3>New Requisition</h3>
                <form id="reqForm" onsubmit="submitRequisition(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="req-number">Requisition Number</label>
                            <input type="text" id="req-number" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="req-date">Date</label>
                            <input type="date" id="req-date" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="department">Department/Unit</label>
                        <select id="department" required onchange="toggleCustomDepartment()">
                            <option value="">Select department</option>
                            <option value="Council">Council</option>
                            <option value="Vice Chancellor">Vice Chancellor</option>
                            <option value="Senate">Senate</option>
                            <option value="ADBOARD">ADBOARD</option>
                            <option value="DVC-A">DVC-A</option>
                            <option value="DVC-PAF">DVC-PAF</option>
                            <option value="Chaplain">Chaplain</option>
                            <option value="Quality Assurance">Quality Assurance</option>
                            <option value="Dean of Students">Dean of Students</option>
                            <option value="ADCOM">ADCOM</option>
                            <option value="Internal Audit">Internal Audit</option>
                            <option value="Procurement Office">Procurement Office</option>
                            <option value="Public Relations">Public Relations</option>
                            <option value="Finance & Accounting">Finance & Accounting</option>
                            <option value="Research and Postgraduate Studies">Research and Postgraduate Studies</option>
                            <option value="ICT">ICT</option>
                            <option value="Registrar's Office">Registrar's Office</option>
                            <option value="Human Resources">Human Resources</option>
                            <option value="Library">Library</option>
                            <option value="School of Business">School of Business</option>
                            <option value="Estate">Estate</option>
                            <option value="Medical Services">Medical Services</option>
                            <option value="Faculty of Theology & Religious Studies">Faculty of Theology & Religious Studies</option>
                            <option value="School of Education">School of Education</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="custom-department-group" style="display: none;">
                        <label for="custom-department">Custom Department Name</label>
                        <input type="text" id="custom-department" placeholder="Enter department name" maxlength="100">
                        <small style="color: #6b7280; font-size: 11px; margin-top: 4px; display: block;">Please specify the department name (maximum 100 characters)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="request-type">Request Type</label>
                        <select id="request-type" required onchange="toggleCustomRequestType()">
                            <option value="">Select request type</option>
                            <option value="office-supplies">Office Supplies</option>
                            <option value="equipment-purchase">Equipment Purchase</option>
                            <option value="professional-services">Professional Services</option>
                            <option value="maintenance-repairs">Maintenance & Repairs</option>
                            <option value="travel-accommodation">Travel & Accommodation</option>
                            <option value="salary-advance">Salary Advance</option>
                            <option value="training-development">Training & Development</option>
                            <option value="goods-materials">Goods/Materials</option>
                            <option value="software-licenses">Software/Licenses</option>
                            <option value="utilities">Utilities</option>
                            <option value="cows-project-supplies">Cows Project Supplies</option>
                            <option value="super-market-supplies">Super Market Supplies</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="custom-request-type-group" style="display: none;">
                        <label for="custom-request-type">Custom Request Type</label>
                        <input type="text" id="custom-request-type" placeholder="Enter custom request type" maxlength="100">
                        <small style="color: #6b7280; font-size: 11px; margin-top: 4px; display: block;">Please specify the type of request (maximum 100 characters)</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="estimated-amount">Requested Amount (TZS)</label>
                            <input type="text" id="estimated-amount" placeholder="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="required-date">Required Date</label>
                            <input type="date" id="required-date" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="description-justification">Description & Justification</label>
                        <textarea id="description-justification" rows="4" placeholder="Provide detailed description and justification for this requisition" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="unit">Unit</label>
                            <input type="text" id="unit" placeholder="Enter unit of measurement (e.g., pieces, boxes, kg, liters)" required maxlength="50">
                        </div>
                        
                        <div class="form-group">
                            <label for="quantity">Quantity</label>
                            <input type="number" id="quantity" min="0" step="1" placeholder="0" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="supporting-doc">Supporting Document (Required - Max 5MB)</label>
                        <input type="file" id="supporting-doc" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.xls" onchange="validateFileSize(this)" required>
                        <small style="color: #6b7280; font-size: 11px; margin-top: 4px; display: block;">Accepted formats: PDF, Word, Excel, Images (JPG, PNG) - Maximum 5MB</small>
                    </div>
                    
                    <button type="submit" class="btn" id="submit-btn">
                        <span id="submit-btn-text">Submit Requisition</span>
                    </button>
                </form>
            </div>

            <div class="sidebar">
                <div class="info-card">
                    <h4>Current User</h4>
                    <div class="stat-item">
                        <span>Role:</span>
                        <span class="stat-value" id="current-user">Not selected</span>
                    </div>
                    <div class="stat-item">
                        <span>Permissions:</span>
                        <span class="stat-value" id="access-level">None</span>
                    </div>
                    <div style="margin-top: 16px;">
                        <div id="admin-user-mgmt" style="display: none; margin-bottom: 12px;">
                            <button class="btn btn-small" onclick="openUserManagement()" style="width: 100%; margin: 0 0 8px 0; background: #2b327a;">Manage Users</button>
                            <button class="btn btn-small" onclick="exportToCSV()" style="width: 100%; margin: 0 0 8px 0; background: #16a34a;">Export CSV</button>
                            <button class="btn btn-small" onclick="exportBackup()" style="width: 100%; margin: 0 0 8px 0; background: #109747;">Export Backup</button>
                            <button class="btn btn-small" onclick="openImportBackup()" style="width: 100%; margin: 0 0 8px 0; background: #f59e0b; color: #ffffff;">Import Backup</button>
                            <button class="btn btn-small" onclick="forceSynchronization()" style="width: 100%; margin: 0 0 8px 0; background: #0ea5e9; color: #ffffff;" id="sync-btn">
                                <span id="sync-btn-text">🔄 Force Sync</span>
                            </button>
                        </div>
                        <button class="btn btn-small btn-danger" onclick="logout()" style="width: 100%; margin: 0; background: transparent; border: 2px solid #dc2626; color: #dc2626;">Logout</button>
                    </div>
                </div>

                <div class="info-card">
                    <h4>Statistics</h4>
                    <div class="stat-item">
                        <span>Total Requests:</span>
                        <span class="stat-value" id="total-requests">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Pending Actions:</span>
                        <span class="stat-value" id="pending-actions">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Storage:</span>
                        <span class="stat-value" id="storage-status">Local</span>
                    </div>
                    <div class="stat-item" id="sync-status-item" style="display: none;">
                        <span>Last Sync:</span>
                        <span class="stat-value" id="last-sync-time">Never</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="workflow-section" id="workflow-section" style="display: none;">
            <h3 class="workflow-title">Workflow Process</h3>
            <div class="workflow-steps">
                <div class="step" id="step-1">1</div>
                <div class="step" id="step-2">2</div>
                <div class="step" id="step-3">3</div>
                <div class="step" id="step-4">4</div>
                <div class="step" id="step-5">5</div>
                <div class="step" id="step-6">6</div>
            </div>
            <div class="step-labels">
                <div class="step-label">Submit (Cashier)</div>
                <div class="step-label">Verify (Chief Accountant)</div>
                <div class="step-label">Authorize (DFA)</div>
                <div class="step-label">Approval 1 (DVC-PAF)</div>
                <div class="step-label">Approval 2 (DVC-A)</div>
                <div class="step-label">Approval 3 (VC)</div>
            </div>
        </div>

        <div class="requisitions-section" id="requisitions-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin: 0;">Active Requisitions</h3>
                <div id="admin-controls" style="display: none;">
                    <button class="btn btn-small btn-danger" onclick="deleteAllRequisitions()" style="background: #dc2626;">Delete All</button>
                </div>
            </div>
            <div id="requisitions-container">
                <div class="empty-state">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm8 8v2h1v-2h-1zm-2-2H7v4h6v-4z" clip-rule="evenodd"></path>
                    </svg>
                    <p>No requisitions found</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="comment-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <h3 id="comment-modal-title">Add Comment</h3>
            <p style="color: #6b7280; margin-bottom: 16px;" id="comment-modal-description">Add your comment for this action:</p>
            
            <div class="form-group">
                <label for="action-comment" id="comment-label">Comment</label>
                <textarea id="action-comment" rows="4" placeholder="Enter your comment..." style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-small btn-secondary" onclick="closeCommentModal()">Cancel</button>
                <button class="btn btn-small" onclick="confirmAction()" id="confirm-action-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Rejection Modal -->
    <div id="rejection-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <h3>Reject Requisition</h3>
            <p style="color: #6b7280; margin-bottom: 16px;">Please provide a reason for rejecting this requisition:</p>
            
            <div class="form-group">
                <label for="rejection-reason">Rejection Reason *</label>
                <textarea id="rejection-reason" rows="4" placeholder="Enter detailed reason for rejection..." required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-small btn-secondary" onclick="closeRejectionModal()">Cancel</button>
                <button class="btn btn-small btn-danger" onclick="confirmRejection()">Reject Requisition</button>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="user-management-modal" class="modal-overlay" style="display: none;">
        <div class="modal" style="max-width: 800px; max-height: 90vh;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">User Management</h3>
                <button class="btn btn-small" onclick="openAddUserModal()" style="background: #109747;">Add New User</button>
            </div>
            
            <div style="max-height: 60vh; overflow-y: auto;">
                <div id="users-list">
                    <!-- Users will be populated here -->
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-small btn-secondary" onclick="closeUserManagement()">Close</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="add-user-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <h3 id="user-modal-title">Add New User</h3>
            
            <form id="user-form" onsubmit="saveUser(event)">
                <div class="form-group">
                    <label for="user-name">Full Name *</label>
                    <input type="text" id="user-name" placeholder="Enter full name" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                </div>
                
                <div class="form-group">
                    <label for="user-role">Role *</label>
                    <select id="user-role" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                        <option value="">Select role</option>
                        <option value="cashier">Cashier</option>
                        <option value="chief-accountant">Chief Accountant</option>
                        <option value="dfa">Director of Finance</option>
                        <option value="dvc-paf">DVC-PAF</option>
                        <option value="dvc-a">DVC-A</option>
                        <option value="vc">Vice Chancellor</option>
                        <option value="admin">System Administrator</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="user-password">Password *</label>
                    <input type="password" id="user-password" placeholder="Enter custom password (minimum 4 characters)" required minlength="4" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                    <small style="color: #6b7280; font-size: 11px; margin-top: 4px; display: block;">Password must be at least 4 characters long. Users will use this password to log in.</small>
                </div>
                
                <div class="form-group">
                    <label for="user-password-confirm">Confirm Password *</label>
                    <input type="password" id="user-password-confirm" placeholder="Re-enter password to confirm" required minlength="4" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                    <small style="color: #6b7280; font-size: 11px; margin-top: 4px; display: block;">Must match the password above</small>
                </div>
                
                <div class="form-group">
                    <label for="user-status">Status</label>
                    <select id="user-status" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn btn-small btn-secondary" onclick="closeAddUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-small" id="save-user-btn">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="modal-overlay" style="display: none;">
        <div class="modal" style="max-width: 700px; max-height: 80vh; height: 600px; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
                <h3 style="margin: 0;" id="chat-modal-title">Chat - Requisition</h3>
                <button onclick="closeChatModal()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #6b7280; padding: 4px;">✕</button>
            </div>
            
            <div id="chat-messages" style="flex: 1; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #f9fafb; margin-bottom: 12px;">
                <div class="empty-chat" style="text-align: center; color: #6b7280; padding: 40px 20px;">
                    <svg style="width: 48px; height: 48px; margin: 0 auto 16px; opacity: 0.5;" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
                    </svg>
                    <p>No messages yet. Start the conversation!</p>
                </div>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <input type="text" id="chat-input" placeholder="Type your message..." style="flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" onkeypress="handleChatKeyPress(event)">
                <button onclick="sendChatMessage()" class="btn" style="padding: 10px 16px; white-space: nowrap;">Send</button>
            </div>
        </div>
    </div>

    <div class="footer-divider"></div>
    <footer class="footer">
        <div class="footer-content">
            <div class="support-info">
                <svg class="phone-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                </svg>
                <span>Support: +255 679 450 092 | +255 659 492 234</span>
            </div>
            <div class="copyright-info">
                © 2025 The University of Arusha. All rights reserved. | Requisition Management System
            </div>
        </div>
    </footer>

    <script>
        // ===========================================
        // FIREBASE INTEGRATION SYSTEM
        // ===========================================

        // Firebase Configuration - REPLACE WITH YOUR PROJECT CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAAvJIUsozCyt48Bz3JZZUqVhvu9YTK6hc",
  authDomain: "uoa-requisition-system-final.firebaseapp.com",
  projectId: "uoa-requisition-system-final",
  storageBucket: "uoa-requisition-system-final.firebasestorage.app",
  messagingSenderId: "548059265476",
  appId: "1:548059265476:web:db9a93aa938d59c075cc91"
        };

        // Initialize Firebase
        let firebaseApp = null;
        let firestore = null;
        let storage = null;
        let isFirebaseConnected = false;

        // Global Variables
        let currentUser = null;
        let currentRole = null;
        let selectedRole = null;
        let selectedUserName = null;
        let requisitions = [];
        let nextReqId = 1;
        let isAuthenticated = false;
        let currentRequisitionToReject = null;
        let currentEditingUser = null;
        let currentChatRequisition = null;
        let chatMessages = {};
        let nextMessageId = 1;
        let lastSyncTime = null;
        let syncInProgress = false;
        let autoSyncInterval = null;

        const rolePermissions = {
            'cashier': { canSubmit: true, canVerify: false, canApprove: false, canAuthorize: false, canDelete: false, canReject: false, title: 'Cashier' },
            'chief-accountant': { canSubmit: false, canVerify: true, canApprove: false, canAuthorize: false, canDelete: false, canReject: true, title: 'Chief Accountant' },
            'dfa': { canSubmit: false, canVerify: false, canApprove: false, canAuthorize: true, canDelete: false, canReject: true, title: 'Director of Accounts and Finance' },
            'dvc-paf': { canSubmit: false, canVerify: false, canApprove: true, canAuthorize: false, canDelete: false, canReject: true, title: 'DVC-PAF' },
            'dvc-a': { canSubmit: false, canVerify: false, canApprove2: true, canAuthorize: false, canDelete: false, canReject: true, title: 'DVC-A' },
            'vc': { canSubmit: false, canVerify: false, canApprove3: true, canAuthorize: false, canDelete: false, canReject: true, title: 'Vice Chancellor' },
            'admin': { canSubmit: false, canVerify: true, canApprove: true, canApprove2: true, canApprove3: true, canAuthorize: true, canDelete: true, canReject: true, title: 'System Administrator' }
        };

        let userDatabase = {
            'cashier': [
                { id: 1, name: 'Mary Njeri', password: '123', status: 'active', createdDate: '2025-01-01' }
            ],
            'chief-accountant': [
                { id: 2, name: 'Robert Kiprotich', password: '123', status: 'active', createdDate: '2025-01-01' }
            ],
            'dfa': [
                { id: 3, name: 'Dr. Michael Nyong\'o', password: '123', status: 'active', createdDate: '2025-01-01' }
            ],
            'dvc-paf': [
                { id: 4, name: 'Prof. Elizabeth Mwangi', password: '123', status: 'active', createdDate: '2025-01-01' }
            ],
            'dvc-a': [
                { id: 5, name: 'Prof. Samuel Kariuki', password: '123', status: 'active', createdDate: '2025-01-01' }
            ],
            'vc': [
                { id: 6, name: 'Prof. Dr. Anthony Makau', password: '123', status: 'active', createdDate: '2025-01-01' }
            ],
            'admin': [
                { id: 7, name: 'System Administrator', password: '123', status: 'active', createdDate: '2025-01-01' }
            ]
        };

        let nextUserId = 8;

        // Firebase Functions
        function initializeFirebase() {
            try {
                // Check if config is properly set
                if (firebaseConfig.apiKey === "your-api-key-here") {
                    console.warn('⚠️ Firebase not configured - using local storage fallback');
                    updateStorageStatus();
                    return Promise.resolve(false);
                }

                firebaseApp = firebase.initializeApp(firebaseConfig);
                firestore = firebase.firestore();
                storage = firebase.storage();
                
                // Test Firestore connection
                return firestore.collection('_test').limit(1).get().then(() => {
                    isFirebaseConnected = true;
                    console.log('✅ Cloud Firestore connected successfully');
                    updateStorageStatus();
                    startAutoSync();
                    return true;
                }).catch(error => {
                    console.error('❌ Cloud Firestore connection error:', error);
                    isFirebaseConnected = false;
                    updateStorageStatus();
                    return false;
                });
            } catch (error) {
                console.error('❌ Firebase initialization error:', error);
                isFirebaseConnected = false;
                updateStorageStatus();
                return Promise.resolve(false);
            }
        }

        function saveToFirebase(collection, data, docId = null) {
            if (!isFirebaseConnected || !firestore) {
                console.log('⚠️ Firestore not connected, using local storage');
                return Promise.resolve(saveToLocalStorage(collection, data));
            }
            
            try {
                if (collection === 'requisitions') {
                    if (Array.isArray(data)) {
                        // Save entire requisitions array as batch
                        const batch = firestore.batch();
                        data.forEach(req => {
                            // Clean the requisition data for Firestore
                            const cleanReq = { ...req };
                            // Remove File objects as they can't be serialized
                            delete cleanReq.supportingDocFile;
                            
                            const reqDocRef = firestore.collection('requisitions').doc(req.id);
                            batch.set(reqDocRef, cleanReq, { merge: true });
                        });
                        
                        return batch.commit().then(() => {
                            console.log(`✅ ${data.length} requisitions saved to Firestore`);
                            saveToLocalStorage(collection, data);
                            return true;
                        }).catch(error => {
                            console.error('❌ Firestore batch save error:', error);
                            showNotification('Firestore save failed, using local storage', 'error');
                            return saveToLocalStorage(collection, data);
                        });
                    } else {
                        // Save single requisition
                        const cleanReq = { ...data };
                        delete cleanReq.supportingDocFile;
                        
                        return firestore.collection('requisitions').doc(data.id).set(cleanReq, { merge: true }).then(() => {
                            console.log(`✅ Requisition ${data.id} saved to Firestore`);
                            saveToLocalStorage(collection, requisitions); // Save full array to local storage
                            return true;
                        }).catch(error => {
                            console.error('❌ Firestore requisition save error:', error);
                            showNotification('Firestore save failed, using local storage', 'error');
                            return saveToLocalStorage(collection, requisitions);
                        });
                    }
                } else if (collection === 'users') {
                    // Save entire user database structure
                    return firestore.collection('users').doc('userDatabase').set(data, { merge: true }).then(() => {
                        console.log('✅ User database saved to Firestore');
                        saveToLocalStorage(collection, data);
                        return true;
                    }).catch(error => {
                        console.error('❌ Firestore users save error:', error);
                        showNotification('Firestore save failed, using local storage', 'error');
                        return saveToLocalStorage(collection, data);
                    });
                } else if (collection === 'settings') {
                    return firestore.collection('settings').doc('appSettings').set(data, { merge: true }).then(() => {
                        console.log('✅ Settings saved to Firestore');
                        saveToLocalStorage(collection, data);
                        return true;
                    }).catch(error => {
                        console.error('❌ Firestore settings save error:', error);
                        return saveToLocalStorage(collection, data);
                    });
                } else if (collection === 'chatMessages') {
                    if (docId) {
                        // Save single message
                        return firestore.collection('chatMessages').doc(docId).set(data, { merge: true }).then(() => {
                            console.log(`✅ Chat message ${docId} saved to Firestore`);
                            saveToLocalStorage(collection, chatMessages);
                            return true;
                        }).catch(error => {
                            console.error('❌ Firestore chat message save error:', error);
                            return saveToLocalStorage(collection, chatMessages);
                        });
                    } else {
                        // Save all chat messages
                        const batch = firestore.batch();
                        Object.keys(data).forEach(reqId => {
                            data[reqId].forEach(msg => {
                                const msgDocRef = firestore.collection('chatMessages').doc(msg.id.toString());
                                batch.set(msgDocRef, msg, { merge: true });
                            });
                        });
                        return batch.commit().then(() => {
                            console.log('✅ Chat messages saved to Firestore');
                            saveToLocalStorage(collection, data);
                            return true;
                        }).catch(error => {
                            console.error('❌ Firestore chat save error:', error);
                            return saveToLocalStorage(collection, data);
                        });
                    }
                } else {
                    // Generic collection save
                    return firestore.collection(collection).doc('data').set(data, { merge: true }).then(() => {
                        console.log(`✅ Data saved to Firestore: ${collection}`);
                        saveToLocalStorage(collection, data);
                        return true;
                    }).catch(error => {
                        console.error('❌ Firestore save error:', error);
                        showNotification('Firestore save failed, using local storage', 'error');
                        return saveToLocalStorage(collection, data);
                    });
                }
            } catch (error) {
                console.error('❌ Firestore save error:', error);
                showNotification('Firestore save failed, using local storage', 'error');
                return Promise.resolve(saveToLocalStorage(collection, data));
            }
        }

        function loadFromFirebase(collection, defaultValue = null) {
            if (!isFirebaseConnected || !firestore) {
                return Promise.resolve(loadFromLocalStorage(collection, defaultValue));
            }
            
            try {
                if (collection === 'requisitions') {
                    return firestore.collection('requisitions').get().then(snapshot => {
                        const data = [];
                        snapshot.forEach(doc => {
                            data.push(doc.data());
                        });
                        console.log(`📥 ${data.length} requisitions loaded from Firestore`);
                        if (data.length > 0) {
                            saveToLocalStorage(collection, data);
                        }
                        return data.length > 0 ? data : defaultValue;
                    }).catch(error => {
                        console.error('❌ Firestore load error:', error);
                        showNotification('Firestore load failed, using local storage', 'error');
                        return loadFromLocalStorage(collection, defaultValue);
                    });
                } else if (collection === 'users') {
                    return firestore.collection('users').doc('userDatabase').get().then(doc => {
                        const data = doc.exists ? doc.data() : null;
                        console.log('📥 User database loaded from Firestore');
                        if (data) {
                            saveToLocalStorage(collection, data);
                        }
                        return data || defaultValue;
                    }).catch(error => {
                        console.error('❌ Firestore users load error:', error);
                        return loadFromLocalStorage(collection, defaultValue);
                    });
                } else if (collection === 'chatMessages') {
                    return firestore.collection('chatMessages').get().then(snapshot => {
                        const data = {};
                        snapshot.forEach(doc => {
                            const msg = doc.data();
                            if (!data[msg.reqId]) {
                                data[msg.reqId] = [];
                            }
                            data[msg.reqId].push(msg);
                        });
                        
                        // Sort messages by timestamp within each requisition
                        Object.keys(data).forEach(reqId => {
                            data[reqId].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        });
                        
                        console.log('📥 Chat messages loaded from Firestore');
                        if (Object.keys(data).length > 0) {
                            saveToLocalStorage(collection, data);
                        }
                        return Object.keys(data).length > 0 ? data : defaultValue;
                    }).catch(error => {
                        console.error('❌ Firestore chat load error:', error);
                        return loadFromLocalStorage(collection, defaultValue);
                    });
                } else if (collection === 'settings') {
                    return firestore.collection('settings').doc('appSettings').get().then(doc => {
                        const data = doc.exists ? doc.data() : null;
                        console.log('📥 Settings loaded from Firestore');
                        if (data) {
                            saveToLocalStorage(collection, data);
                        }
                        return data || defaultValue;
                    }).catch(error => {
                        console.error('❌ Firestore settings load error:', error);
                        return loadFromLocalStorage(collection, defaultValue);
                    });
                } else {
                    return firestore.collection(collection).doc('data').get().then(doc => {
                        const data = doc.exists ? doc.data() : null;
                        console.log(`📥 Data loaded from Firestore: ${collection}`);
                        if (data) {
                            saveToLocalStorage(collection, data);
                        }
                        return data || defaultValue;
                    }).catch(error => {
                        console.error('❌ Firestore load error:', error);
                        return loadFromLocalStorage(collection, defaultValue);
                    });
                }
            } catch (error) {
                console.error('❌ Firestore load error:', error);
                return Promise.resolve(loadFromLocalStorage(collection, defaultValue));
            }
        }

        function uploadFileToFirebase(file, path) {
            if (!isFirebaseConnected || !storage) {
                return Promise.resolve({ downloadURL: null, fileName: file.name, size: file.size });
            }
            
            try {
                const storageRef = storage.ref().child(path);
                return storageRef.put(file).then(snapshot => {
                    return snapshot.ref.getDownloadURL().then(downloadURL => {
                        console.log(`📤 File uploaded to Firebase: ${path}`);
                        return { downloadURL, fileName: file.name, size: file.size };
                    });
                }).catch(error => {
                    console.error('❌ Firebase file upload error:', error);
                    showNotification('File upload failed', 'error');
                    return { downloadURL: null, fileName: file.name, size: file.size };
                });
            } catch (error) {
                console.error('❌ Firebase file upload error:', error);
                return Promise.resolve({ downloadURL: null, fileName: file.name, size: file.size });
            }
        }

        function setupFirebaseListeners() {
            if (!isFirebaseConnected || !firestore) return;
            
            try {
                // Listen for requisitions changes
                firestore.collection('requisitions').onSnapshot((snapshot) => {
                    const data = [];
                    snapshot.forEach(doc => {
                        data.push(doc.data());
                    });
                    
                    if (JSON.stringify(data) !== JSON.stringify(requisitions)) {
                        requisitions.length = 0;
                        requisitions.push(...data);
                        updateUI();
                        console.log('📡 Requisitions updated from Firestore');
                    }
                }, (error) => {
                    console.error('❌ Requisitions listener error:', error);
                });

                // Listen for user database changes
                firestore.collection('users').doc('userDatabase').onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data && JSON.stringify(data) !== JSON.stringify(userDatabase)) {
                            Object.keys(userDatabase).forEach(key => delete userDatabase[key]);
                            Object.assign(userDatabase, data);
                            updateUI();
                            console.log('📡 Users updated from Firestore');
                        }
                    }
                }, (error) => {
                    console.error('❌ Users listener error:', error);
                });

                // Listen for chat messages changes
                firestore.collection('chatMessages').onSnapshot((snapshot) => {
                    const data = {};
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        if (!data[msg.reqId]) {
                            data[msg.reqId] = [];
                        }
                        data[msg.reqId].push(msg);
                    });
                    
                    // Sort messages by timestamp within each requisition
                    Object.keys(data).forEach(reqId => {
                        data[reqId].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    });
                    
                    if (JSON.stringify(data) !== JSON.stringify(chatMessages)) {
                        chatMessages = data;
                        if (currentChatRequisition) {
                            loadChatMessages(currentChatRequisition);
                        }
                        updateUI();
                        console.log('📡 Chat messages updated from Firestore');
                    }
                }, (error) => {
                    console.error('❌ Chat messages listener error:', error);
                });

                console.log('📡 Firestore listeners setup complete');
            } catch (error) {
                console.error('❌ Firestore listeners setup error:', error);
            }
        }

        // Fallback functions for local storage
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(`uoa_${key}`, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showNotification('Storage error: Unable to save data', 'error');
                return false;
            }
        }

        function loadFromLocalStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(`uoa_${key}`);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return defaultValue;
            }
        }

        function updateStorageStatus() {
            const statusElement = document.getElementById('storage-status');
            const syncStatusItem = document.getElementById('sync-status-item');
            const lastSyncElement = document.getElementById('last-sync-time');
            
            if (isFirebaseConnected) {
                statusElement.textContent = syncInProgress ? 'Syncing...' : 'Firestore';
                statusElement.style.color = syncInProgress ? '#f59e0b' : '#059669';
                statusElement.style.fontWeight = '600';
                statusElement.title = 'Connected to Cloud Firestore - Real-time sync enabled';
                
                // Show sync status for admin
                if (currentRole === 'admin') {
                    syncStatusItem.style.display = 'flex';
                    if (lastSyncTime) {
                        const timeAgo = getTimeAgo(lastSyncTime);
                        lastSyncElement.textContent = timeAgo;
                        lastSyncElement.style.color = '#059669';
                    } else {
                        lastSyncElement.textContent = 'Never';
                        lastSyncElement.style.color = '#dc2626';
                    }
                } else {
                    syncStatusItem.style.display = 'none';
                }
            } else {
                statusElement.textContent = 'Local Only';
                statusElement.style.color = '#dc2626';
                statusElement.style.fontWeight = '600';
                statusElement.title = 'Using local storage only - Firestore unavailable';
                syncStatusItem.style.display = 'none';
            }
        }

        // Initialize Application
        async function initializeApp() {
            try {
                console.log('🚀 Initializing University of Arusha Requisition System...');
                
                // Initialize Firebase first
                const firebaseInitialized = await initializeFirebase();
                
                if (firebaseInitialized) {
                    console.log('🔥 Firebase initialized successfully');
                    setupFirebaseListeners();
                    
                    // Load data from Firestore
                    try {
                        const [savedRequisitions, savedUserDatabase, savedChatMessages, savedSettings] = await Promise.all([
                            loadFromFirebase('requisitions', []),
                            loadFromFirebase('users', null),
                            loadFromFirebase('chatMessages', {}),
                            loadFromFirebase('settings', { nextReqId: 1, nextUserId: 8, nextMessageId: 1 })
                        ]);

                        if (savedRequisitions && savedRequisitions.length > 0) {
                            requisitions.length = 0;
                            requisitions.push(...(Array.isArray(savedRequisitions) ? savedRequisitions : Object.values(savedRequisitions)));
                            console.log(`📋 Loaded ${requisitions.length} requisitions from Firestore`);
                        }

                        if (savedUserDatabase && Object.keys(savedUserDatabase).length > 0) {
                            Object.keys(userDatabase).forEach(key => delete userDatabase[key]);
                            Object.assign(userDatabase, savedUserDatabase);
                            console.log('👥 Loaded user database from Firestore');
                        } else {
                            console.log('🔧 Using default user database, saving to Firestore');
                            await saveToFirebase('users', userDatabase);
                        }

                        if (savedChatMessages && Object.keys(savedChatMessages).length > 0) {
                            chatMessages = savedChatMessages;
                            console.log('💬 Loaded chat messages from Firestore');
                        }

                        if (savedSettings) {
                            nextReqId = savedSettings.nextReqId || 1;
                            nextUserId = savedSettings.nextUserId || 8;
                            nextMessageId = savedSettings.nextMessageId || 1;
                            console.log('⚙️ Loaded settings from Firestore');
                        }

                    } catch (error) {
                        console.error('❌ Error loading from Firestore, using local storage:', error);
                        loadFromLocalStorageFallback();
                    }
                } else {
                    console.log('📱 Firebase not available, using local storage');
                    loadFromLocalStorageFallback();
                }

                // Setup event listeners
                document.getElementById('password').addEventListener('input', updateLoginButton);
                document.getElementById('password').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        authenticateUser();
                    }
                });

                // Update storage status
                updateStorageStatus();
                
                console.log('✅ Application initialized successfully');
                
            } catch (error) {
                console.error('❌ Error initializing app:', error);
                showNotification('Application initialized with limited functionality.', 'error');
                loadFromLocalStorageFallback();
                updateStorageStatus();
            }
        }

        function loadFromLocalStorageFallback() {
            try {
                const savedRequisitions = loadFromLocalStorage('requisitions', []);
                if (savedRequisitions && savedRequisitions.length > 0) {
                    requisitions.length = 0;
                    requisitions.push(...savedRequisitions);
                    console.log(`📋 Loaded ${savedRequisitions.length} requisitions from local storage`);
                }

                const savedUserDatabase = loadFromLocalStorage('users', null);
                if (savedUserDatabase && Object.keys(savedUserDatabase).length > 0) {
                    Object.keys(userDatabase).forEach(key => delete userDatabase[key]);
                    Object.assign(userDatabase, savedUserDatabase);
                    console.log('👥 Loaded user database from local storage');
                } else {
                    console.log('🔧 Using default user database');
                    saveToLocalStorage('users', userDatabase);
                }

                const savedChatMessages = loadFromLocalStorage('chatMessages', {});
                if (savedChatMessages) {
                    chatMessages = savedChatMessages;
                    console.log('💬 Loaded chat messages from local storage');
                }

                // Load counters
                const savedNextReqId = loadFromLocalStorage('settings/nextReqId', 1);
                const savedNextUserId = loadFromLocalStorage('settings/nextUserId', 8);
                const savedNextMessageId = loadFromLocalStorage('settings/nextMessageId', 1);
                
                if (savedNextReqId) nextReqId = savedNextReqId;
                if (savedNextUserId) nextUserId = savedNextUserId;
                if (savedNextMessageId) nextMessageId = savedNextMessageId;
            } catch (error) {
                console.error('❌ Error loading from local storage:', error);
            }
        }



        // Toggle Custom Request Type Input
        function toggleCustomRequestType() {
            const requestTypeSelect = document.getElementById('request-type');
            const customGroup = document.getElementById('custom-request-type-group');
            const customInput = document.getElementById('custom-request-type');
            
            if (requestTypeSelect.value === 'other') {
                customGroup.style.display = 'block';
                customInput.required = true;
                customInput.focus();
            } else {
                customGroup.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // Toggle Custom Department Input
        function toggleCustomDepartment() {
            const departmentSelect = document.getElementById('department');
            const customGroup = document.getElementById('custom-department-group');
            const customInput = document.getElementById('custom-department');
            
            if (departmentSelect.value === 'other') {
                customGroup.style.display = 'block';
                customInput.required = true;
                customInput.focus();
            } else {
                customGroup.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // Submit Requisition Function
        async function submitRequisition(event) {
            event.preventDefault();
            
            if (!currentRole || !rolePermissions[currentRole].canSubmit) {
                showNotification('You do not have permission to submit requisitions', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submit-btn');
            const submitBtnText = document.getElementById('submit-btn-text');
            submitBtn.disabled = true;
            submitBtnText.innerHTML = '<span class="loading-spinner"></span>Submitting...';
            
            try {
                const fileInput = document.getElementById('supporting-doc');
                const supportingFile = fileInput.files[0];
                
                if (supportingFile) {
                    const maxSize = 5 * 1024 * 1024; // 5MB in bytes
                    if (supportingFile.size > maxSize) {
                        showNotification('Cannot submit: File size exceeds 5MB limit', 'error');
                        submitBtn.disabled = false;
                        submitBtnText.textContent = 'Submit Requisition';
                        return;
                    }
                }
                
                const reqId = document.getElementById('req-number').value;
                
                // Get request type (use custom if "other" is selected)
                const requestTypeSelect = document.getElementById('request-type').value;
                const customRequestType = document.getElementById('custom-request-type').value.trim();
                const finalRequestType = requestTypeSelect === 'other' ? customRequestType : requestTypeSelect;
                
                // Get department (use custom if "other" is selected)
                const departmentSelect = document.getElementById('department').value;
                const customDepartment = document.getElementById('custom-department').value.trim();
                const finalDepartment = departmentSelect === 'other' ? customDepartment : departmentSelect;
                
                // Get unit from text input
                const finalUnit = document.getElementById('unit').value.trim();
                
                // Upload file to Firebase Storage if available
                let fileInfo = { downloadURL: null, fileName: 'None', size: 0 };
                if (supportingFile) {
                    submitBtnText.innerHTML = '<span class="loading-spinner"></span>Uploading file...';
                    const filePath = `requisitions/${reqId}/${supportingFile.name}`;
                    fileInfo = await uploadFileToFirebase(supportingFile, filePath);
                }
                
                submitBtnText.innerHTML = '<span class="loading-spinner"></span>Saving requisition...';
                
                const requisition = {
                    id: reqId,
                    date: document.getElementById('req-date').value,
                    department: finalDepartment,
                    departmentCategory: departmentSelect,
                    requestType: finalRequestType,
                    requestTypeCategory: requestTypeSelect,
                    estimatedAmount: document.getElementById('estimated-amount').value.replace(/,/g, ''),
                    requiredDate: document.getElementById('required-date').value,
                    description: document.getElementById('description-justification').value,
                    unit: finalUnit,
                    quantity: document.getElementById('quantity').value,
                    supportingDoc: fileInfo.fileName !== 'None' ? `${fileInfo.fileName} (${(fileInfo.size / (1024 * 1024)).toFixed(2)}MB)` : 'None',
                    supportingDocFile: supportingFile || null, // Keep for local storage
                    supportingDocURL: fileInfo.downloadURL, // Firebase Storage URL
                    submittedBy: currentUser,
                    submittedDate: new Date().toLocaleDateString(),
                    submittedTimestamp: new Date().toISOString(),
                    submittedComment: 'Initial submission',
                    status: 'pending'
                };
                
                requisitions.push(requisition);
                nextReqId++;
                
                // Save to Firestore/Local Storage
                if (isFirebaseConnected) {
                    await Promise.all([
                        saveToFirebase('requisitions', requisitions),
                        saveToFirebase('settings', { nextReqId, nextUserId, nextMessageId })
                    ]);
                } else {
                    saveToLocalStorage('requisitions', requisitions);
                    saveToLocalStorage('settings', { nextReqId, nextUserId, nextMessageId });
                }
                
                event.target.reset();
                initializeForm();
                updateUI();
                animateWorkflowStep(1);
                
            } catch (error) {
                console.error('Submission error:', error);
                showNotification('Error submitting requisition. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtnText.textContent = 'Submit Requisition';
            }
        }

        function verifyRequisition(reqId) {
            if (!rolePermissions[currentRole].canVerify) {
                showNotification('You do not have permission to verify requisitions', 'error');
                return;
            }
            
            const req = requisitions.find(r => r.id === reqId);
            if (req && req.status === 'pending') {
                openCommentModal('verify', reqId, 'Verify Requisition', 'Add verification comment (optional):');
            }
        }

        function authorizeRequisition(reqId) {
            if (!rolePermissions[currentRole].canAuthorize) {
                showNotification('You do not have permission to authorize requisitions', 'error');
                return;
            }
            
            const req = requisitions.find(r => r.id === reqId);
            if (req && (req.status === 'verified' || req.status === 'authorized' || req.status === 'approved1' || req.status === 'approved2' || req.status === 'approved3')) {
                const action = req.authorizedBy ? 'Re-Authorize' : 'Authorize';
                openCommentModal('authorize', reqId, `${action} Requisition`, 'Add authorization comment (optional):');
            }
        }

        function approveRequisition1(reqId) {
            if (!rolePermissions[currentRole].canApprove) {
                showNotification('You do not have permission to approve requisitions', 'error');
                return;
            }
            
            const req = requisitions.find(r => r.id === reqId);
            if (req && (req.status === 'verified' || req.status === 'authorized' || req.status === 'approved1' || req.status === 'approved2' || req.status === 'approved3')) {
                const action = req.approved1By ? 'Re-Approve 1' : 'Approval 1';
                openCommentModal('approve1', reqId, `${action} Requisition`, 'Add approval comment (optional):');
            }
        }

        function approveRequisition2(reqId) {
            if (!rolePermissions[currentRole].canApprove2) {
                showNotification('You do not have permission to provide Approval 2', 'error');
                return;
            }
            
            const req = requisitions.find(r => r.id === reqId);
            if (req && (req.status === 'verified' || req.status === 'authorized' || req.status === 'approved1' || req.status === 'approved2' || req.status === 'approved3')) {
                const action = req.approved2By ? 'Re-Approve 2' : 'Approval 2';
                openCommentModal('approve2', reqId, `${action} Requisition`, 'Add approval comment (optional):');
            }
        }

        function approveRequisition3(reqId) {
            if (!rolePermissions[currentRole].canApprove3) {
                showNotification('You do not have permission to provide Approval 3', 'error');
                return;
            }
            
            const req = requisitions.find(r => r.id === reqId);
            if (req && (req.status === 'verified' || req.status === 'authorized' || req.status === 'approved1' || req.status === 'approved2' || req.status === 'approved3')) {
                const action = req.approved3By ? 'Re-Approve 3' : 'Approval 3';
                openCommentModal('approve3', reqId, `${action} Requisition`, 'Add final approval comment (optional):');
            }
        }

        function rejectRequisition(reqId) {
            if (!rolePermissions[currentRole].canReject) {
                showNotification('You do not have permission to reject requisitions', 'error');
                return;
            }
            
            const req = requisitions.find(r => r.id === reqId);
            if (req && req.status !== 'rejected' && req.status !== 'approved3') {
                currentRequisitionToReject = reqId;
                document.getElementById('rejection-modal').style.display = 'flex';
                document.getElementById('rejection-reason').value = '';
                document.getElementById('rejection-reason').focus();
            } else {
                showNotification('This requisition cannot be rejected', 'error');
            }
        }

        function confirmRejection() {
            const reason = document.getElementById('rejection-reason').value.trim();
            
            if (!reason) {
                showNotification('Please provide a reason for rejection', 'error');
                return;
            }
            
            if (currentRequisitionToReject) {
                const req = requisitions.find(r => r.id === currentRequisitionToReject);
                if (req) {
                    req.status = 'rejected';
                    req.rejectedBy = currentUser;
                    req.rejectionReason = reason;
                    req.rejectionDate = new Date().toLocaleDateString();
                    
                    // Save to Firestore/Local Storage
                    if (isFirebaseConnected) {
                        saveToFirebase('requisitions', requisitions);
                    } else {
                        saveToLocalStorage('requisitions', requisitions);
                    }
                    
                    updateUI();
                    closeRejectionModal();
                }
            }
        }

        function deleteRequisition(reqId) {
            if (!rolePermissions[currentRole].canDelete) {
                showNotification('You do not have permission to delete requisitions', 'error');
                return;
            }
            
            if (confirm(`Are you sure you want to delete requisition ${reqId}? This action cannot be undone.`)) {
                const index = requisitions.findIndex(r => r.id === reqId);
                if (index !== -1) {
                    requisitions.splice(index, 1);
                    
                    // Save to Firestore/Local Storage
                    if (isFirebaseConnected) {
                        saveToFirebase('requisitions', requisitions);
                    } else {
                        saveToLocalStorage('requisitions', requisitions);
                    }
                    
                    updateUI();
                    showNotification(`Requisition ${reqId} deleted`);
                }
            }
        }

        function exportToCSV() {
            if (currentRole !== 'admin') {
                showNotification('Access denied. Admin privileges required.', 'error');
                return;
            }
            
            try {
                if (requisitions.length === 0) {
                    showNotification('No requisitions to export', 'error');
                    return;
                }
                
                const headers = [
                    'Requisition ID', 'Date Submitted', 'Department', 'Request Type',
                    'Estimated Amount (TZS)', 'Required Date', 'Unit', 'Quantity',
                    'Description', 'Submitted By', 'Status', 'Verified By', 'Verified Date',
                    'Approved By', 'Approved Date', 'Authorized By', 'Authorized Date',
                    'Rejected By', 'Rejection Date', 'Rejection Reason', 'Supporting Document'
                ];
                
                const csvData = requisitions.map(req => [
                    req.id || '', req.submittedDate || req.date || '', req.department || '',
                    req.requestType || '', req.estimatedAmount || '0', req.requiredDate || '', 
                    req.unit || '', req.quantity || '0', (req.description || '').replace(/"/g, '""').replace(/\n/g, ' '),
                    req.submittedBy || '', req.status || '', req.verifiedBy || '',
                    req.verifiedDate || '', req.approvedBy || '', req.approvedDate || '',
                    req.authorizedBy || '', req.authorizedDate || '', req.rejectedBy || '',
                    req.rejectionDate || '', (req.rejectionReason || '').replace(/"/g, '""').replace(/\n/g, ' '),
                    req.supportingDoc && req.supportingDoc !== 'None' ? req.supportingDoc.split(' (')[0] : 'None'
                ]);
                
                const csvContent = [
                    headers.map(header => `"${header}"`).join(','),
                    ...csvData.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');
                
                const csvBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(csvBlob);
                link.download = `UoA_Requisitions_Export_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`CSV export completed! ${requisitions.length} requisitions exported.`);
            } catch (error) {
                console.error('CSV export error:', error);
                showNotification('CSV export failed: ' + error.message, 'error');
            }
        }

        function exportBackup() {
            if (currentRole !== 'admin') {
                showNotification('Access denied. Admin privileges required.', 'error');
                return;
            }
            
            try {
                const backupData = {
                    version: '2.0-local',
                    exportDate: new Date().toISOString(),
                    exportedBy: currentUser,
                    userDatabase: userDatabase,
                    requisitions: requisitions.map(req => {
                        const exportReq = { ...req };
                        delete exportReq.supportingDocFile;
                        return exportReq;
                    }),
                    chatMessages: chatMessages,
                    nextReqId: nextReqId,
                    nextUserId: nextUserId,
                    nextMessageId: nextMessageId
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `UoA_Requisition_Backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Backup exported successfully');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Export failed: ' + error.message, 'error');
            }
        }

        function downloadFile(reqId) {
            const req = requisitions.find(r => r.id === reqId);
            if (!req) {
                showNotification('Requisition not found', 'error');
                return;
            }
            
            // Try Firebase Storage URL first
            if (req.supportingDocURL) {
                const a = document.createElement('a');
                a.href = req.supportingDocURL;
                a.download = req.supportingDoc.split(' (')[0]; // Get filename without size info
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showNotification(`Downloading ${req.supportingDoc.split(' (')[0]}`);
                return;
            }
            
            // Fallback to local file
            if (req.supportingDocFile) {
                const url = URL.createObjectURL(req.supportingDocFile);
                const a = document.createElement('a');
                a.href = url;
                a.download = req.supportingDocFile.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification(`Downloading ${req.supportingDocFile.name}`);
                return;
            }
            
            showNotification('File not found', 'error');
        }

        function validateFileSize(input) {
            const file = input.files[0];
            if (file) {
                const maxSize = 5 * 1024 * 1024; // 5MB
                
                if (file.size > maxSize) {
                    showNotification('File size exceeds 5MB limit. Please select a smaller file.', 'error');
                    input.value = '';
                    return false;
                }
                
                const allowedTypes = [
                    'application/pdf', 'application/msword',
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    'application/vnd.ms-excel',
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'image/jpeg', 'image/jpg', 'image/png'
                ];
                
                if (!allowedTypes.includes(file.type)) {
                    showNotification('File type not supported. Please select a PDF, Word, Excel, or image file.', 'error');
                    input.value = '';
                    return false;
                }
                
                return true;
            }
        }

        function selectRole(role) {
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            selectedRole = role;
            
            document.getElementById('auth-section').style.display = 'block';
            populateUserDropdown(role);
            
            isAuthenticated = false;
            document.getElementById('selected-user').textContent = 'Select User';
            document.getElementById('password').value = '';
            document.getElementById('login-btn').disabled = true;
            
            hideMainContent();
        }

        function populateUserDropdown(role) {
            const dropdown = document.getElementById('dropdown-menu');
            const users = userDatabase[role] || [];
            const activeUsers = users.filter(user => user.status === 'active');
            
            if (activeUsers.length === 0) {
                dropdown.innerHTML = '<div class="dropdown-item" style="color: #6b7280; font-style: italic;">No active users found for this role</div>';
                return;
            }
            
            dropdown.innerHTML = activeUsers.map(user => 
                `<div class="dropdown-item" onclick="selectUser('${user.name.replace(/'/g, "\\'")}')">${user.name}</div>`
            ).join('');
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdown-menu');
            const arrow = document.getElementById('dropdown-arrow');
            
            dropdown.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        function selectUser(userName) {
            selectedUserName = userName;
            document.getElementById('selected-user').textContent = userName;
            document.getElementById('dropdown-menu').classList.remove('open');
            document.getElementById('dropdown-arrow').classList.remove('open');
            
            updateLoginButton();
        }

        function updateLoginButton() {
            const loginBtn = document.getElementById('login-btn');
            const password = document.getElementById('password').value;
            
            loginBtn.disabled = !selectedUserName || !password;
        }

        function authenticateUser() {
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('login-btn');
            const loginBtnText = document.getElementById('login-btn-text');
            
            if (!selectedRole || !selectedUserName || !password) {
                showNotification('Please select a user and enter password', 'error');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtnText.innerHTML = '<span class="loading-spinner"></span>Authenticating...';
            
            try {
                const users = userDatabase[selectedRole];
                
                if (!users || users.length === 0) {
                    showNotification('No users found for this role', 'error');
                    resetLoginButton();
                    return;
                }
                
                const user = users.find(u => u.name === selectedUserName && u.password === password);
                
                if (user) {
                    if (user.status === 'inactive') {
                        showNotification('This account has been deactivated. Please contact administrator.', 'error');
                        resetLoginButton();
                        return;
                    }
                    
                    // Successful authentication
                    isAuthenticated = true;
                    currentRole = selectedRole;
                    currentUser = selectedUserName;
                    
                    console.log('Authentication successful:', { currentRole, currentUser });
                    
                    document.getElementById('auth-section').style.display = 'none';
                    showMainContent();
                    updateUI();
                    
                    showNotification(`Welcome, ${currentUser}!`);
                    
                } else {
                    showNotification('Invalid password. Please try again.', 'error');
                    resetLoginButton();
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showNotification('Authentication failed. Please try again.', 'error');
                resetLoginButton();
            }
            
            // Reset button state immediately after processing
            loginBtn.disabled = false;
            loginBtnText.textContent = 'Login';
            
            function resetLoginButton() {
                document.getElementById('password').value = '';
                updateLoginButton();
            }
        }

        function hideMainContent() {
            document.getElementById('role-selection').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('workflow-section').style.display = 'none';
            document.getElementById('requisitions-section').style.display = 'none';
        }

        function showMainContent() {
            document.getElementById('role-selection').style.display = 'none';
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('main-content').style.display = 'grid';
            document.getElementById('workflow-section').style.display = 'block';
            document.getElementById('requisitions-section').style.display = 'block';
            
            initializeForm();
        }

        function updateUI() {
            document.getElementById('current-user').textContent = currentUser || 'Not selected';
            
            const permissions = rolePermissions[currentRole];
            if (permissions) {
                let accessLevel = [];
                if (permissions.canSubmit) accessLevel.push('Submit');
                if (permissions.canVerify) accessLevel.push('Verify');
                if (permissions.canAuthorize) accessLevel.push('Authorize');
                if (permissions.canApprove) accessLevel.push('Approval 1');
                if (permissions.canApprove2) accessLevel.push('Approval 2');
                if (permissions.canApprove3) accessLevel.push('Approval 3');
                if (permissions.canReject) accessLevel.push('Reject');
                if (permissions.canDelete) accessLevel.push('Delete');
                
                document.getElementById('access-level').textContent = accessLevel.join(', ') || 'View Only';
                
                const formCard = document.getElementById('requisition-form');
                if (permissions && permissions.canSubmit) {
                    formCard.style.display = 'block';
                } else {
                    formCard.style.display = 'none';
                }

                const adminControls = document.getElementById('admin-controls');
                const adminUserMgmt = document.getElementById('admin-user-mgmt');
                if (currentRole === 'admin') {
                    adminControls.style.display = 'block';
                    adminUserMgmt.style.display = 'block';
                } else {
                    adminControls.style.display = 'none';
                    adminUserMgmt.style.display = 'none';
                }
            }
            
            updateStats();
            renderRequisitions();
        }

        function updateStats() {
            const permissions = rolePermissions[currentRole];
            let visibleRequisitions = [];
            let pendingActions = 0;
            
            if (permissions) {
                if (permissions.canSubmit && !permissions.canVerify && !permissions.canApprove && !permissions.canApprove2 && !permissions.canApprove3 && !permissions.canAuthorize) {
                    visibleRequisitions = requisitions.filter(req => req.submittedBy === currentUser);
                } else if (currentRole === 'chief-accountant') {
                    // Chief Accountant can see all requisitions
                    visibleRequisitions = requisitions;
                } else if (permissions.canVerify || permissions.canApprove || permissions.canApprove2 || permissions.canApprove3 || permissions.canAuthorize || permissions.canDelete) {
                    visibleRequisitions = requisitions.filter(req => {
                        if (permissions.canVerify && req.status === 'pending') return true;
                        if (permissions.canAuthorize && req.status === 'verified') return true;
                        if (permissions.canApprove && req.status === 'authorized') return true;
                        if (permissions.canApprove2 && req.status === 'approved1') return true;
                        if (permissions.canApprove3 && req.status === 'approved2') return true;
                        if (permissions.canDelete) return true;
                        if (permissions.canReject && req.status !== 'approved3') return true;
                        return false;
                    });
                }
                
                // Calculate pending actions based on current user's role and what they can act on
                requisitions.forEach(req => {
                    // Chief Accountant - can verify pending requisitions
                    if (permissions.canVerify && req.status === 'pending') {
                        pendingActions++;
                    }
                    
                    // Director of Finance - can authorize verified requisitions
                    if (permissions.canAuthorize && req.status === 'verified') {
                        pendingActions++;
                    }
                    
                    // DVC-PAF - can provide first approval on authorized requisitions
                    if (permissions.canApprove && req.status === 'authorized') {
                        pendingActions++;
                    }
                    
                    // DVC-A - can provide second approval on first-approved requisitions
                    if (permissions.canApprove2 && req.status === 'approved1') {
                        pendingActions++;
                    }
                    
                    // Vice Chancellor - can provide final approval on second-approved requisitions
                    if (permissions.canApprove3 && req.status === 'approved2') {
                        pendingActions++;
                    }
                });
            }
            
            document.getElementById('total-requests').textContent = visibleRequisitions.length;
            document.getElementById('pending-actions').textContent = pendingActions;
        }

        function initializeForm() {
            document.getElementById('req-number').value = `REQ-${String(nextReqId).padStart(4, '0')}`;
            document.getElementById('req-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('required-date').min = new Date().toISOString().split('T')[0];
            
            const amountInput = document.getElementById('estimated-amount');
            amountInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/,/g, '');
                if (!isNaN(value) && value !== '') {
                    e.target.value = parseFloat(value).toLocaleString();
                }
            });
        }

        function renderRequisitions() {
            const container = document.getElementById('requisitions-container');
            
            let filteredRequisitions = [];
            const permissions = rolePermissions[currentRole];
            
            if (permissions) {
                if (permissions.canSubmit && !permissions.canVerify && !permissions.canApprove && !permissions.canApprove2 && !permissions.canApprove3 && !permissions.canAuthorize) {
                    filteredRequisitions = requisitions.filter(req => req.submittedBy === currentUser);
                } else if (currentRole === 'chief-accountant') {
                    // Chief Accountant can see all requisitions regardless of status
                    filteredRequisitions = requisitions;
                } else if (permissions.canVerify || permissions.canApprove || permissions.canApprove2 || permissions.canApprove3 || permissions.canAuthorize || permissions.canDelete) {
                    filteredRequisitions = requisitions.filter(req => {
                        if (permissions.canVerify && req.status === 'pending') return true;
                        if (permissions.canAuthorize && (req.status === 'verified' || req.status === 'authorized' || req.status === 'approved1' || req.status === 'approved2' || req.status === 'approved3')) return true;
                        if (permissions.canApprove && (req.status === 'verified' || req.status === 'authorized' || req.status === 'approved1' || req.status === 'approved2' || req.status === 'approved3')) return true;
                        if (permissions.canApprove2 && (req.status === 'verified' || req.status === 'authorized' || req.status === 'approved1' || req.status === 'approved2' || req.status === 'approved3')) return true;
                        if (permissions.canApprove3 && (req.status === 'verified' || req.status === 'authorized' || req.status === 'approved1' || req.status === 'approved2' || req.status === 'approved3')) return true;
                        if (permissions.canDelete) return true;
                        if (permissions.canReject && req.status !== 'approved3') return true;
                        return false;
                    });
                }
            }
            
            if (filteredRequisitions.length === 0) {
                const emptyMessage = permissions && (permissions.canSubmit && !permissions.canVerify) 
                    ? "You haven't submitted any requisitions yet" 
                    : "No requisitions require your attention";
                    
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm8 8v2h1v-2h-1zm-2-2H7v4h6v-4z" clip-rule="evenodd"></path>
                        </svg>
                        <p>${emptyMessage}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredRequisitions.map(req => {
                const permissions = rolePermissions[currentRole];
                let actionButtons = '';
                
                if (permissions) {
                    if (permissions.canVerify && req.status === 'pending') {
                        actionButtons += `<button class="btn btn-small btn-warning" onclick="verifyRequisition('${req.id}')">Verify</button>`;
                    }
                    if (permissions.canAuthorize && (req.status === 'verified' || req.status === 'authorized' || req.status === 'approved1' || req.status === 'approved2' || req.status === 'approved3')) {
                        const buttonText = req.authorizedBy ? 'Re-Authorize' : 'Authorize';
                        actionButtons += `<button class="btn btn-small" onclick="authorizeRequisition('${req.id}')">${buttonText}</button>`;
                    }
                    if (permissions.canApprove && (req.status === 'verified' || req.status === 'authorized' || req.status === 'approved1' || req.status === 'approved2' || req.status === 'approved3')) {
                        const buttonText = req.approved1By ? 'Re-Approve 1' : 'Approval 1';
                        actionButtons += `<button class="btn btn-small btn-success" onclick="approveRequisition1('${req.id}')">${buttonText}</button>`;
                    }
                    if (permissions.canApprove2 && (req.status === 'verified' || req.status === 'authorized' || req.status === 'approved1' || req.status === 'approved2' || req.status === 'approved3')) {
                        const buttonText = req.approved2By ? 'Re-Approve 2' : 'Approval 2';
                        actionButtons += `<button class="btn btn-small" onclick="approveRequisition2('${req.id}')" style="background: #7c3aed;">${buttonText}</button>`;
                    }
                    if (permissions.canApprove3 && (req.status === 'verified' || req.status === 'authorized' || req.status === 'approved1' || req.status === 'approved2' || req.status === 'approved3')) {
                        const buttonText = req.approved3By ? 'Re-Approve 3' : 'Approval 3';
                        actionButtons += `<button class="btn btn-small" onclick="approveRequisition3('${req.id}')" style="background: #059669;">${buttonText}</button>`;
                    }
                    if (permissions.canReject && req.status !== 'rejected' && req.status !== 'approved3') {
                        actionButtons += `<button class="btn btn-small btn-danger" onclick="rejectRequisition('${req.id}')">Reject</button>`;
                    }

                    if (permissions.canDelete) {
                        actionButtons += `<button class="btn btn-small btn-danger" onclick="deleteRequisition('${req.id}')">Delete</button>`;
                    }
                    
                    if (currentRole === 'admin' && req.status === 'approved3') {
                        actionButtons += `<button class="btn btn-small" onclick="printRequisition('${req.id}')" style="background: #109747;">Print</button>`;
                    }
                    
                    // Allow submitter to print once requisition is authorized or has any approval
                    if (permissions.canSubmit && !permissions.canVerify && !permissions.canApprove && !permissions.canApprove2 && !permissions.canApprove3 && !permissions.canAuthorize && req.submittedBy === currentUser && (req.status === 'authorized' || req.approved1By || req.approved2By || req.approved3By)) {
                        actionButtons += `<button class="btn btn-small" onclick="printRequisition('${req.id}')" style="background: #109747;">Print</button>`;
                    }

                    // Add chat button for all users who can see the requisition
                    actionButtons += `<button class="btn btn-small" onclick="openChatModal('${req.id}')" style="background: #0ea5e9; position: relative;">
                        💬 Chat
                        ${getChatNotificationBadge(req.id)}
                    </button>`;
                }
                
                return `
                    <div class="requisition-item">
                        <div class="req-header">
                            <div class="req-id">${req.id}</div>
                            <div class="status-badge status-${req.status}">${req.status}</div>
                        </div>
                        <div class="req-details">
                            <strong>${req.requestType || 'General Request'}</strong> • ${req.department}<br>
                            Qty: ${req.quantity} ${req.unit ? req.unit.charAt(0).toUpperCase() + req.unit.slice(1) : ''} • Amount: TZS ${parseFloat(req.estimatedAmount || 0).toLocaleString()}<br>
                            Submitted by ${req.submittedBy} on ${req.submittedDate}<br>
                            ${req.description ? `<div style="margin: 8px 0; padding: 8px; background: #f9fafb; border-radius: 4px; border-left: 3px solid #2b327a;"><strong style="color: #2b327a;">Description & Justification:</strong><br><span style="color: #374151; font-style: italic; line-height: 1.4;">${req.description}</span></div>` : ''}
                            ${req.status === 'rejected' ? `<span style="color: #dc2626; font-weight: 500;">❌ Rejected by ${req.rejectedBy} on ${req.rejectionDate}</span><br><span style="color: #dc2626; font-style: italic;">Reason: ${req.rejectionReason}</span><br>` : ''}
                            ${req.submittedComment ? `<div style="margin: 4px 0; padding: 6px; background: #f0f9ff; border-radius: 4px; border-left: 3px solid #0ea5e9;"><strong style="color: #0369a1;">📝 Submission:</strong> <span style="color: #0c4a6e; font-style: italic;">${req.submittedComment}</span></div>` : ''}
                            ${req.verifiedBy ? `<span style="color: #065f46; font-weight: 500;">✓ Verified by ${req.verifiedBy} on ${req.verifiedDate}</span><br>` : ''}
                            ${req.verifiedComment ? `<div style="margin: 4px 0; padding: 6px; background: #f0fdf4; border-radius: 4px; border-left: 3px solid #22c55e;"><strong style="color: #15803d;">💬 Verification:</strong> <span style="color: #166534; font-style: italic;">${req.verifiedComment}</span></div>` : ''}
                            ${req.authorizedBy ? `<span style="color: #1e40af; font-weight: 500;">✓ Authorized by ${req.authorizedBy} on ${req.authorizedDate}</span><br>` : ''}
                            ${req.authorizedComment ? `<div style="margin: 4px 0; padding: 6px; background: #eff6ff; border-radius: 4px; border-left: 3px solid #3b82f6;"><strong style="color: #1d4ed8;">💬 Authorization:</strong> <span style="color: #1e40af; font-style: italic;">${req.authorizedComment}</span></div>` : ''}
                            ${req.approved1By ? `<span style="color: #3730a3; font-weight: 500;">✓ Approval 1 by ${req.approved1By} on ${req.approved1Date}</span><br>` : ''}
                            ${req.approved1Comment ? `<div style="margin: 4px 0; padding: 6px; background: #f5f3ff; border-radius: 4px; border-left: 3px solid #8b5cf6;"><strong style="color: #7c3aed;">💬 Approval 1:</strong> <span style="color: #6d28d9; font-style: italic;">${req.approved1Comment}</span></div>` : ''}
                            ${req.approved2By ? `<span style="color: #6b21a8; font-weight: 500;">✓ Approval 2 by ${req.approved2By} on ${req.approved2Date}</span><br>` : ''}
                            ${req.approved2Comment ? `<div style="margin: 4px 0; padding: 6px; background: #faf5ff; border-radius: 4px; border-left: 3px solid #a855f7;"><strong style="color: #9333ea;">💬 Approval 2:</strong> <span style="color: #7e22ce; font-style: italic;">${req.approved2Comment}</span></div>` : ''}
                            ${req.approved3By ? `<span style="color: #166534; font-weight: 500;">✓ Final Approval by ${req.approved3By} on ${req.approved3Date}</span><br>` : ''}
                            ${req.approved3Comment ? `<div style="margin: 4px 0; padding: 6px; background: #ecfdf5; border-radius: 4px; border-left: 3px solid #10b981;"><strong style="color: #059669;">💬 Final Approval:</strong> <span style="color: #047857; font-style: italic;">${req.approved3Comment}</span></div>` : ''}
                            ${req.supportingDoc && req.supportingDoc !== 'None' ? `<span style="color: #2b327a; font-weight: 500;">📎 Supporting Document: <button onclick="downloadFile('${req.id}')" style="background: none; border: none; color: #2b327a; text-decoration: underline; cursor: pointer; font-size: inherit; padding: 0;">${req.supportingDoc.split(' (')[0]}</button></span>` : '<span style="color: #6b7280;">📎 No supporting document</span>'}
                        </div>
                        ${actionButtons ? `<div class="req-actions">${actionButtons}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function animateWorkflowStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            for (let i = 1; i < stepNumber; i++) {
                document.getElementById(`step-${i}`).classList.add('completed');
            }
            
            document.getElementById(`step-${stepNumber}`).classList.add('active');
        }

        function logout() {
            // Stop auto-sync when logging out
            stopAutoSync();
            
            currentUser = null;
            currentRole = null;
            selectedRole = null;
            selectedUserName = null;
            isAuthenticated = false;
            
            document.getElementById('selected-user').textContent = 'Select User';
            document.getElementById('password').value = '';
            document.getElementById('login-btn').disabled = true;
            
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('role-selection').style.display = 'block';
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('workflow-section').style.display = 'none';
            document.getElementById('requisitions-section').style.display = 'none';
            
            updateUI();
        }

        async function deleteAllRequisitions() {
            if (!rolePermissions[currentRole].canDelete) {
                showNotification('You do not have permission to delete requisitions', 'error');
                return;
            }
            
            if (requisitions.length === 0) {
                showNotification('No requisitions to delete', 'error');
                return;
            }
            
            const totalCount = requisitions.length;
            if (confirm(`Are you sure you want to delete ALL ${totalCount} requisitions? This action cannot be undone.`)) {
                requisitions.length = 0;
                nextReqId = 1;
                
                // Save to Firestore/Local Storage
                try {
                    if (isFirebaseConnected) {
                        await Promise.all([
                            saveToFirebase('requisitions', requisitions),
                            saveToFirebase('settings', { nextReqId, nextUserId, nextMessageId })
                        ]);
                    } else {
                        saveToLocalStorage('requisitions', requisitions);
                        saveToLocalStorage('settings', { nextReqId, nextUserId, nextMessageId });
                    }
                    
                    updateUI();
                    showNotification(`All ${totalCount} requisitions have been deleted`);
                } catch (error) {
                    console.error('Error deleting requisitions:', error);
                    showNotification('Error deleting requisitions. Please try again.', 'error');
                }
            }
        }

        // Comment Modal Functions
        let currentActionType = null;
        let currentActionReqId = null;

        function openCommentModal(actionType, reqId, title, description) {
            currentActionType = actionType;
            currentActionReqId = reqId;
            
            document.getElementById('comment-modal-title').textContent = title;
            document.getElementById('comment-modal-description').textContent = description;
            document.getElementById('action-comment').value = '';
            document.getElementById('comment-modal').style.display = 'flex';
            document.getElementById('action-comment').focus();
            
            // Update button text based on action
            const confirmBtn = document.getElementById('confirm-action-btn');
            switch(actionType) {
                case 'verify': confirmBtn.textContent = 'Verify'; break;
                case 'authorize': confirmBtn.textContent = 'Authorize'; break;
                case 'approve1': confirmBtn.textContent = 'Approve'; break;
                case 'approve2': confirmBtn.textContent = 'Approve'; break;
                case 'approve3': confirmBtn.textContent = 'Approve'; break;
                default: confirmBtn.textContent = 'Confirm';
            }
        }

        function closeCommentModal() {
            document.getElementById('comment-modal').style.display = 'none';
            currentActionType = null;
            currentActionReqId = null;
            document.getElementById('action-comment').value = '';
        }

        async function confirmAction() {
            const comment = document.getElementById('action-comment').value.trim();
            
            if (!currentActionType || !currentActionReqId) {
                showNotification('Invalid action', 'error');
                return;
            }
            
            const req = requisitions.find(r => r.id === currentActionReqId);
            if (!req) {
                showNotification('Requisition not found', 'error');
                return;
            }
            
            // Perform the action based on type
            switch(currentActionType) {
                case 'verify':
                    req.status = 'verified';
                    req.verifiedBy = currentUser;
                    req.verifiedDate = new Date().toLocaleDateString();
                    req.verifiedComment = comment || 'No comment provided';
                    animateWorkflowStep(2);
                    break;
                    
                case 'authorize':
                    if (req.status === 'verified') {
                        req.status = 'authorized';
                    }
                    req.authorizedBy = currentUser;
                    req.authorizedDate = new Date().toLocaleDateString();
                    req.authorizedComment = comment || 'No comment provided';
                    animateWorkflowStep(3);
                    break;
                    
                case 'approve1':
                    if (req.status === 'authorized') {
                        req.status = 'approved1';
                    }
                    req.approved1By = currentUser;
                    req.approved1Date = new Date().toLocaleDateString();
                    req.approved1Comment = comment || 'No comment provided';
                    animateWorkflowStep(4);
                    break;
                    
                case 'approve2':
                    if (req.status === 'approved1') {
                        req.status = 'approved2';
                    }
                    req.approved2By = currentUser;
                    req.approved2Date = new Date().toLocaleDateString();
                    req.approved2Comment = comment || 'No comment provided';
                    animateWorkflowStep(5);
                    break;
                    
                case 'approve3':
                    req.status = 'approved3';
                    req.approved3By = currentUser;
                    req.approved3Date = new Date().toLocaleDateString();
                    req.approved3Comment = comment || 'No comment provided';
                    animateWorkflowStep(6);
                    break;
            }
            
            // Save to Firestore/Local Storage
            try {
                if (isFirebaseConnected) {
                    await saveToFirebase('requisitions', requisitions);
                } else {
                    saveToLocalStorage('requisitions', requisitions);
                }
                updateUI();
                closeCommentModal();
            } catch (error) {
                console.error('Error saving action:', error);
                showNotification('Error saving action. Please try again.', 'error');
            }
        }

        function closeRejectionModal() {
            document.getElementById('rejection-modal').style.display = 'none';
            currentRequisitionToReject = null;
            document.getElementById('rejection-reason').value = '';
        }

        function printRequisition(reqId) {
            const req = requisitions.find(r => r.id === reqId);
            if (!req) {
                showNotification('Requisition not found', 'error');
                return;
            }

            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Requisition ${req.id} - Print</title>
                    <style>
                        @page { size: A4; margin: 0.5in; }
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; color: #333; font-size: 11px; line-height: 1.3; }
                        .header { text-align: center; border-bottom: 1px solid #2b327a; padding-bottom: 8px; margin-bottom: 15px; }
                        .header h1 { color: #2b327a; margin: 0; font-size: 16px; font-weight: bold; }
                        .header p { color: #666; margin: 2px 0 0 0; font-size: 10px; }
                        .req-info { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
                        .info-section { background: #f9fafb; padding: 8px; border-radius: 4px; border: 1px solid #e5e7eb; }
                        .info-section h3 { color: #2b327a; margin: 0 0 6px 0; font-size: 11px; font-weight: bold; }
                        .info-row { margin-bottom: 4px; display: flex; justify-content: space-between; }
                        .label { font-weight: bold; color: #374151; font-size: 10px; }
                        .value { color: #6b7280; font-size: 10px; text-align: right; max-width: 60%; }
                        .description { margin: 12px 0; }
                        .description h3 { color: #2b327a; margin-bottom: 6px; font-size: 11px; font-weight: bold; }
                        .description-text { background: #f9fafb; padding: 8px; border-radius: 4px; line-height: 1.4; font-size: 10px; border: 1px solid #e5e7eb; }
                        .status-section { text-align: center; margin: 12px 0; }
                        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 15px; font-weight: bold; text-transform: uppercase; font-size: 10px; }
                        .status-authorized { background: #dcfce7; color: #166534; border: 1px solid #166534; }
                        .footer { margin-top: 15px; text-align: center; font-size: 9px; color: #6b7280; border-top: 1px solid #e5e7eb; padding-top: 8px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 8px;">
                            <img src="https://i.postimg.cc/fbSDf7bB/uoalogo.png" alt="University of Arusha Logo" style="width: 40px; height: 40px; object-fit: contain;" onerror="this.style.display='none';">
                            <div>
                                <h1>THE UNIVERSITY OF ARUSHA</h1>
                                <p>Requisition Management System - Approved Document</p>
                            </div>
                        </div>
                    </div>

                    <div class="req-info">
                        <div class="info-section">
                            <h3>Requisition Details</h3>
                            <div class="info-row"><span class="label">ID:</span><span class="value">${req.id}</span></div>
                            <div class="info-row"><span class="label">Date:</span><span class="value">${req.date}</span></div>
                            <div class="info-row"><span class="label">Department:</span><span class="value">${req.department}</span></div>
                            <div class="info-row"><span class="label">Submitted By:</span><span class="value">${req.submittedBy}</span></div>

                        </div>
                        <div class="info-section">
                            <h3>Request Information</h3>
                            <div class="info-row"><span class="label">Type:</span><span class="value">${req.requestType}</span></div>
                            <div class="info-row"><span class="label">Unit:</span><span class="value">${req.unit ? req.unit.charAt(0).toUpperCase() + req.unit.slice(1) : 'Not specified'}</span></div>
                            <div class="info-row"><span class="label">Quantity:</span><span class="value">${req.quantity}</span></div>
                            <div class="info-row"><span class="label">Amount:</span><span class="value">TZS ${parseFloat(req.estimatedAmount).toLocaleString()}</span></div>
                            <div class="info-row"><span class="label">Required:</span><span class="value">${req.requiredDate}</span></div>
                        </div>
                    </div>

                    <div class="description">
                        <h3>Description & Justification</h3>
                        <div class="description-text">${req.description}</div>
                    </div>

                    <div class="approval-history" style="margin: 15px 0;">
                        <h3 style="color: #2b327a; margin-bottom: 8px; font-size: 11px; font-weight: bold;">Approval History & Workflow</h3>
                        <div class="approval-stages" style="background: #f9fafb; padding: 10px; border-radius: 4px; border: 1px solid #e5e7eb;">
                            <div class="stage-item" style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="stage-label" style="font-weight: bold; color: #374151; font-size: 10px;">1. Submission:</span>
                                <span class="stage-info" style="color: #6b7280; font-size: 10px;">${req.submittedBy} on ${req.submittedDate || req.date}</span>
                            </div>
                            ${req.verifiedBy ? `
                            <div class="stage-item" style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="stage-label" style="font-weight: bold; color: #065f46; font-size: 10px;">2. Verification:</span>
                                <span class="stage-info" style="color: #065f46; font-size: 10px;">${req.verifiedBy} on ${req.verifiedDate}</span>
                            </div>
                            ${req.verifiedComment && req.verifiedComment !== 'No comment provided' ? `
                            <div class="comment-item" style="margin-left: 15px; font-style: italic; color: #6b7280; font-size: 9px; padding: 2px 0;">
                                Comment: "${req.verifiedComment}"
                            </div>` : ''}
                            ` : `
                            <div class="stage-item" style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="stage-label" style="font-weight: bold; color: #9ca3af; font-size: 10px;">2. Verification:</span>
                                <span class="stage-info" style="color: #9ca3af; font-size: 10px;">Pending</span>
                            </div>
                            `}
                            ${req.authorizedBy ? `
                            <div class="stage-item" style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="stage-label" style="font-weight: bold; color: #1e40af; font-size: 10px;">3. Authorization:</span>
                                <span class="stage-info" style="color: #1e40af; font-size: 10px;">${req.authorizedBy} on ${req.authorizedDate}</span>
                            </div>
                            ${req.authorizedComment && req.authorizedComment !== 'No comment provided' ? `
                            <div class="comment-item" style="margin-left: 15px; font-style: italic; color: #6b7280; font-size: 9px; padding: 2px 0;">
                                Comment: "${req.authorizedComment}"
                            </div>` : ''}
                            ` : `
                            <div class="stage-item" style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="stage-label" style="font-weight: bold; color: #9ca3af; font-size: 10px;">3. Authorization:</span>
                                <span class="stage-info" style="color: #9ca3af; font-size: 10px;">Pending</span>
                            </div>
                            `}
                            ${req.approved1By ? `
                            <div class="stage-item" style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="stage-label" style="font-weight: bold; color: #3730a3; font-size: 10px;">4. Approval 1 (DVC-PAF):</span>
                                <span class="stage-info" style="color: #3730a3; font-size: 10px;">${req.approved1By} on ${req.approved1Date}</span>
                            </div>
                            ${req.approved1Comment && req.approved1Comment !== 'No comment provided' ? `
                            <div class="comment-item" style="margin-left: 15px; font-style: italic; color: #6b7280; font-size: 9px; padding: 2px 0;">
                                Comment: "${req.approved1Comment}"
                            </div>` : ''}
                            ` : `
                            <div class="stage-item" style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="stage-label" style="font-weight: bold; color: #9ca3af; font-size: 10px;">4. Approval 1 (DVC-PAF):</span>
                                <span class="stage-info" style="color: #9ca3af; font-size: 10px;">Pending</span>
                            </div>
                            `}
                            ${req.approved2By ? `
                            <div class="stage-item" style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="stage-label" style="font-weight: bold; color: #6b21a8; font-size: 10px;">5. Approval 2 (DVC-A):</span>
                                <span class="stage-info" style="color: #6b21a8; font-size: 10px;">${req.approved2By} on ${req.approved2Date}</span>
                            </div>
                            ${req.approved2Comment && req.approved2Comment !== 'No comment provided' ? `
                            <div class="comment-item" style="margin-left: 15px; font-style: italic; color: #6b7280; font-size: 9px; padding: 2px 0;">
                                Comment: "${req.approved2Comment}"
                            </div>` : ''}
                            ` : `
                            <div class="stage-item" style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="stage-label" style="font-weight: bold; color: #9ca3af; font-size: 10px;">5. Approval 2 (DVC-A):</span>
                                <span class="stage-info" style="color: #9ca3af; font-size: 10px;">Pending</span>
                            </div>
                            `}
                            ${req.approved3By ? `
                            <div class="stage-item" style="display: flex; justify-content: space-between; padding: 4px 0;">
                                <span class="stage-label" style="font-weight: bold; color: #166534; font-size: 10px;">6. Final Approval (VC):</span>
                                <span class="stage-info" style="color: #166534; font-size: 10px;">${req.approved3By} on ${req.approved3Date}</span>
                            </div>
                            ${req.approved3Comment && req.approved3Comment !== 'No comment provided' ? `
                            <div class="comment-item" style="margin-left: 15px; font-style: italic; color: #6b7280; font-size: 9px; padding: 2px 0;">
                                Comment: "${req.approved3Comment}"
                            </div>` : ''}
                            ` : `
                            <div class="stage-item" style="display: flex; justify-content: space-between; padding: 4px 0;">
                                <span class="stage-label" style="font-weight: bold; color: #9ca3af; font-size: 10px;">6. Final Approval (VC):</span>
                                <span class="stage-info" style="color: #9ca3af; font-size: 10px;">Pending</span>
                            </div>
                            `}
                        </div>
                    </div>

                    <div class="signatories-section" style="margin: 20px 0; page-break-inside: avoid;">
                        <h3 style="color: #2b327a; margin-bottom: 15px; font-size: 11px; font-weight: bold; text-align: center;">For Accounting Department Only</h3>
                        <div class="signatures-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div class="signature-box" style="text-align: center; border: 1px solid #e5e7eb; padding: 15px; border-radius: 4px; background: #f9fafb;">
                                <div style="height: 40px; border-bottom: 1px solid #d1d5db; margin-bottom: 8px; display: flex; align-items: flex-end; justify-content: center;">
                                    <span style="font-size: 9px; color: #6b7280;">Signature</span>
                                </div>
                                <div style="font-weight: bold; color: #2b327a; font-size: 10px; margin-bottom: 2px;">Prepared by:</div>
                                <div style="font-size: 10px; color: #374151; margin-bottom: 2px;">${req.submittedBy}</div>
                                <div style="font-size: 9px; color: #6b7280;">Cashier</div>
                            </div>
                            
                            <div class="signature-box" style="text-align: center; border: 1px solid #e5e7eb; padding: 15px; border-radius: 4px; background: #f9fafb;">
                                <div style="height: 40px; border-bottom: 1px solid #d1d5db; margin-bottom: 8px; display: flex; align-items: flex-end; justify-content: center;">
                                    <span style="font-size: 9px; color: #6b7280;">Signature</span>
                                </div>
                                <div style="font-weight: bold; color: #2b327a; font-size: 10px; margin-bottom: 2px;">Verified by:</div>
                                <div style="font-size: 10px; color: #374151; margin-bottom: 2px;">${req.verifiedBy || '_________________'}</div>
                                <div style="font-size: 9px; color: #6b7280;">Chief Accountant</div>
                            </div>
                            
                            <div class="signature-box" style="text-align: center; border: 1px solid #e5e7eb; padding: 15px; border-radius: 4px; background: #f9fafb;">
                                <div style="height: 40px; border-bottom: 1px solid #d1d5db; margin-bottom: 8px; display: flex; align-items: flex-end; justify-content: center;">
                                    <span style="font-size: 9px; color: #6b7280;">Signature</span>
                                </div>
                                <div style="font-weight: bold; color: #2b327a; font-size: 10px; margin-bottom: 2px;">Authorized by:</div>
                                <div style="font-size: 10px; color: #374151; margin-bottom: 2px;">${req.authorizedBy || '_________________'}</div>
                                <div style="font-size: 9px; color: #6b7280;">Director of Finance</div>
                            </div>
                        </div>
                    </div>

                    <div class="footer">
                        <p><strong>The University of Arusha - Requisition Management System</strong></p>
                        <p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                        <p>Support: +255 679 450 092 | +255 659 492 234</p>
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(printContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
            
            showNotification(`Print preview opened for requisition ${req.id}`);
        }

        // User Management Functions
        function openUserManagement() {
            if (currentRole !== 'admin') {
                showNotification('Access denied. Admin privileges required.', 'error');
                return;
            }
            
            document.getElementById('user-management-modal').style.display = 'flex';
            loadUsersList();
        }

        function closeUserManagement() {
            document.getElementById('user-management-modal').style.display = 'none';
        }

        function loadUsersList() {
            const usersList = document.getElementById('users-list');
            let allUsers = [];
            
            Object.keys(userDatabase).forEach(role => {
                userDatabase[role].forEach(user => {
                    allUsers.push({
                        ...user,
                        role: role,
                        roleTitle: rolePermissions[role].title
                    });
                });
            });
            
            if (allUsers.length === 0) {
                usersList.innerHTML = '<div class="empty-state"><p>No users found</p></div>';
                return;
            }
            
            usersList.innerHTML = allUsers.map(user => `
                <div class="user-item" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                    <div class="user-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div class="user-name" style="font-weight: 600; color: #2b327a;">${user.name}</div>
                        <div class="user-status status-${user.status}" style="padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; ${user.status === 'active' ? 'background: #dcfce7; color: #166534;' : 'background: #fee2e2; color: #991b1b;'}">${user.status}</div>
                    </div>
                    <div class="user-details" style="color: #6b7280; font-size: 11px; margin-bottom: 8px;">
                        <strong>Role:</strong> ${user.roleTitle}<br>
                        <strong>Created:</strong> ${user.createdDate}<br>
                        <strong>User ID:</strong> ${user.id}
                    </div>
                    <div class="user-actions" style="display: flex; gap: 6px;">
                        <button class="btn btn-small" onclick="editUser(${user.id}, '${user.role}')" style="background: #2b327a; padding: 4px 8px; font-size: 9px;">Edit</button>
                        <button class="btn btn-small ${user.status === 'active' ? 'btn-warning' : 'btn-success'}" onclick="toggleUserStatus(${user.id}, '${user.role}')" style="padding: 4px 8px; font-size: 9px;">${user.status === 'active' ? 'Deactivate' : 'Activate'}</button>
                        <button class="btn btn-small btn-danger" onclick="deleteUser(${user.id}, '${user.role}')" style="padding: 4px 8px; font-size: 9px;">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function openAddUserModal() {
            currentEditingUser = null;
            document.getElementById('user-modal-title').textContent = 'Add New User';
            document.getElementById('user-form').reset();
            document.getElementById('save-user-btn').textContent = 'Save User';
            document.getElementById('add-user-modal').style.display = 'flex';
        }

        function closeAddUserModal() {
            document.getElementById('add-user-modal').style.display = 'none';
            currentEditingUser = null;
        }

        function editUser(userId, role) {
            const user = userDatabase[role].find(u => u.id === userId);
            if (!user) return;
            
            currentEditingUser = { userId, role };
            document.getElementById('user-modal-title').textContent = 'Edit User';
            document.getElementById('user-name').value = user.name;
            document.getElementById('user-role').value = role;
            document.getElementById('user-password').value = user.password;
            document.getElementById('user-password-confirm').value = user.password;
            document.getElementById('user-status').value = user.status;
            document.getElementById('save-user-btn').textContent = 'Update User';
            document.getElementById('add-user-modal').style.display = 'flex';
        }

        async function saveUser(event) {
            event.preventDefault();
            
            const name = document.getElementById('user-name').value.trim();
            const role = document.getElementById('user-role').value;
            const password = document.getElementById('user-password').value;
            const passwordConfirm = document.getElementById('user-password-confirm').value;
            const status = document.getElementById('user-status').value;
            
            if (password !== passwordConfirm) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            try {
                if (currentEditingUser) {
                    const user = userDatabase[currentEditingUser.role].find(u => u.id === currentEditingUser.userId);
                    if (user) {
                        if (currentEditingUser.role !== role) {
                            const userIndex = userDatabase[currentEditingUser.role].findIndex(u => u.id === currentEditingUser.userId);
                            userDatabase[currentEditingUser.role].splice(userIndex, 1);
                            
                            user.role = role;
                            if (!userDatabase[role]) userDatabase[role] = [];
                            userDatabase[role].push(user);
                        }
                        
                        user.name = name;
                        user.password = password;
                        user.status = status;
                        
                        if (isFirebaseConnected) {
                            await saveToFirebase('users', userDatabase);
                        } else {
                            saveToLocalStorage('users', userDatabase);
                        }
                        showNotification('User updated successfully');
                    }
                } else {
                    const newUser = {
                        id: nextUserId++,
                        name: name,
                        password: password,
                        status: status,
                        createdDate: new Date().toLocaleDateString()
                    };
                    
                    if (!userDatabase[role]) userDatabase[role] = [];
                    userDatabase[role].push(newUser);
                    
                    if (isFirebaseConnected) {
                        await Promise.all([
                            saveToFirebase('users', userDatabase),
                            saveToFirebase('settings', { nextReqId, nextUserId, nextMessageId })
                        ]);
                    } else {
                        saveToLocalStorage('users', userDatabase);
                        saveToLocalStorage('settings', { nextReqId, nextUserId, nextMessageId });
                    }
                    showNotification('User added successfully');
                }
                
                closeAddUserModal();
                loadUsersList();
            } catch (error) {
                console.error('Error saving user:', error);
                showNotification('Error saving user. Please try again.', 'error');
            }
        }

        async function toggleUserStatus(userId, role) {
            const user = userDatabase[role].find(u => u.id === userId);
            if (user) {
                user.status = user.status === 'active' ? 'inactive' : 'active';
                
                try {
                    if (isFirebaseConnected) {
                        await saveToFirebase('users', userDatabase);
                    } else {
                        saveToLocalStorage('users', userDatabase);
                    }
                    
                    loadUsersList();
                    showNotification(`User ${user.status === 'active' ? 'activated' : 'deactivated'}`);
                } catch (error) {
                    console.error('Error updating user status:', error);
                    showNotification('Error updating user status. Please try again.', 'error');
                }
            }
        }

        async function deleteUser(userId, role) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                const userIndex = userDatabase[role].findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    userDatabase[role].splice(userIndex, 1);
                    
                    try {
                        if (isFirebaseConnected) {
                            await saveToFirebase('users', userDatabase);
                        } else {
                            saveToLocalStorage('users', userDatabase);
                        }
                        
                        loadUsersList();
                        showNotification('User deleted successfully');
                    } catch (error) {
                        console.error('Error deleting user:', error);
                        showNotification('Error deleting user. Please try again.', 'error');
                    }
                }
            }
        }

        function openImportBackup() {
            if (currentRole !== 'admin') {
                showNotification('Access denied. Admin privileges required.', 'error');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            
                            if (confirm('This will replace all current data with the backup. Are you sure?')) {
                                try {
                                    if (backupData.userDatabase) {
                                        Object.keys(userDatabase).forEach(key => delete userDatabase[key]);
                                        Object.assign(userDatabase, backupData.userDatabase);
                                    }
                                    
                                    if (backupData.requisitions) {
                                        requisitions.length = 0;
                                        requisitions.push(...backupData.requisitions);
                                    }
                                    
                                    if (backupData.chatMessages) {
                                        chatMessages = backupData.chatMessages;
                                    }
                                    
                                    if (backupData.nextReqId) {
                                        nextReqId = backupData.nextReqId;
                                    }
                                    
                                    if (backupData.nextUserId) {
                                        nextUserId = backupData.nextUserId;
                                    }
                                    
                                    if (backupData.nextMessageId) {
                                        nextMessageId = backupData.nextMessageId;
                                    }
                                    
                                    // Save to Firestore/Local Storage
                                    if (isFirebaseConnected) {
                                        await Promise.all([
                                            saveToFirebase('users', userDatabase),
                                            saveToFirebase('requisitions', requisitions),
                                            saveToFirebase('chatMessages', chatMessages),
                                            saveToFirebase('settings', { nextReqId, nextUserId, nextMessageId })
                                        ]);
                                    } else {
                                        saveToLocalStorage('users', userDatabase);
                                        saveToLocalStorage('requisitions', requisitions);
                                        saveToLocalStorage('chatMessages', chatMessages);
                                        saveToLocalStorage('settings', { nextReqId, nextUserId, nextMessageId });
                                    }
                                    
                                    updateUI();
                                    showNotification('Backup imported successfully');
                                } catch (error) {
                                    console.error('Import save error:', error);
                                    showNotification('Backup imported but some data may not have saved properly', 'error');
                                }
                            }
                        } catch (error) {
                            console.error('Import error:', error);
                            showNotification('Import failed: Invalid backup file', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Chat Functions
        function openChatModal(reqId) {
            const req = requisitions.find(r => r.id === reqId);
            if (!req) {
                showNotification('Requisition not found', 'error');
                return;
            }

            currentChatRequisition = reqId;
            document.getElementById('chat-modal-title').textContent = `Chat - Requisition ${reqId}`;
            document.getElementById('chat-modal').style.display = 'flex';
            document.getElementById('chat-input').value = '';
            
            loadChatMessages(reqId);
            document.getElementById('chat-input').focus();
            
            // Mark messages as read for current user
            markMessagesAsRead(reqId);
        }

        function closeChatModal() {
            document.getElementById('chat-modal').style.display = 'none';
            currentChatRequisition = null;
        }

        function loadChatMessages(reqId) {
            const messagesContainer = document.getElementById('chat-messages');
            const messages = chatMessages[reqId] || [];
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-chat" style="text-align: center; color: #6b7280; padding: 40px 20px;">
                        <svg style="width: 48px; height: 48px; margin: 0 auto 16px; opacity: 0.5;" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
                        </svg>
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }

            messagesContainer.innerHTML = messages.map(msg => {
                const isCurrentUser = msg.sender === currentUser;
                const messageTime = new Date(msg.timestamp).toLocaleString();
                
                return `
                    <div class="chat-message" style="margin-bottom: 12px; display: flex; ${isCurrentUser ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}">
                        <div style="max-width: 70%; ${isCurrentUser ? 'background: #2b327a; color: white;' : 'background: white; color: #374151; border: 1px solid #e5e7eb;'} padding: 8px 12px; border-radius: 12px; ${isCurrentUser ? 'border-bottom-right-radius: 4px;' : 'border-bottom-left-radius: 4px;'}">
                            <div style="font-weight: 600; font-size: 11px; margin-bottom: 4px; ${isCurrentUser ? 'color: #e5e7eb;' : 'color: #2b327a;'}">${msg.sender}</div>
                            <div style="font-size: 13px; line-height: 1.4; word-wrap: break-word;">${msg.message}</div>
                            <div style="font-size: 10px; margin-top: 4px; opacity: 0.7;">${messageTime}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || !currentChatRequisition) {
                return;
            }
            
            const newMessage = {
                id: nextMessageId++,
                reqId: currentChatRequisition,
                sender: currentUser,
                senderRole: currentRole,
                message: message,
                timestamp: new Date().toISOString(),
                readBy: [currentUser] // Mark as read by sender
            };
            
            if (!chatMessages[currentChatRequisition]) {
                chatMessages[currentChatRequisition] = [];
            }
            
            chatMessages[currentChatRequisition].push(newMessage);
            
            // Save to Firestore/Local Storage
            try {
                if (isFirebaseConnected) {
                    await Promise.all([
                        saveToFirebase('chatMessages', newMessage, newMessage.id.toString()),
                        saveToFirebase('settings', { nextReqId, nextUserId, nextMessageId })
                    ]);
                } else {
                    saveToLocalStorage('chatMessages', chatMessages);
                    saveToLocalStorage('settings', { nextReqId, nextUserId, nextMessageId });
                }
                
                input.value = '';
                loadChatMessages(currentChatRequisition);
                updateUI(); // Refresh to update notification badges
                
                showNotification('Message sent');
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Error sending message. Please try again.', 'error');
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function getChatNotificationBadge(reqId) {
            const messages = chatMessages[reqId] || [];
            const unreadCount = messages.filter(msg => 
                msg.sender !== currentUser && 
                (!msg.readBy || !msg.readBy.includes(currentUser))
            ).length;
            
            if (unreadCount > 0) {
                return `<span style="position: absolute; top: -6px; right: -6px; background: #dc2626; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold;">${unreadCount > 9 ? '9+' : unreadCount}</span>`;
            }
            
            return '';
        }

        async function markMessagesAsRead(reqId) {
            const messages = chatMessages[reqId] || [];
            let hasUpdates = false;
            
            messages.forEach(msg => {
                if (msg.sender !== currentUser) {
                    if (!msg.readBy) {
                        msg.readBy = [];
                    }
                    if (!msg.readBy.includes(currentUser)) {
                        msg.readBy.push(currentUser);
                        hasUpdates = true;
                    }
                }
            });
            
            if (hasUpdates) {
                try {
                    if (isFirebaseConnected) {
                        await saveToFirebase('chatMessages', chatMessages);
                    } else {
                        saveToLocalStorage('chatMessages', chatMessages);
                    }
                    updateUI(); // Refresh to update notification badges
                } catch (error) {
                    console.error('Error marking messages as read:', error);
                }
            }
        }

        // Synchronization Functions
        function startAutoSync() {
            if (!isFirebaseConnected) return;
            
            // Clear existing interval
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
            }
            
            // Auto-sync every 30 seconds for real-time updates
            autoSyncInterval = setInterval(() => {
                if (!syncInProgress) {
                    performQuietSync();
                }
            }, 30000);
            
            console.log('🔄 Auto-sync started (30-second intervals)');
        }

        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
                console.log('⏹️ Auto-sync stopped');
            }
        }

        async function performQuietSync() {
            if (!isFirebaseConnected || syncInProgress) return;
            
            try {
                syncInProgress = true;
                
                // Quick sync without UI feedback
                await Promise.all([
                    saveToFirebase('requisitions', requisitions),
                    saveToFirebase('users', userDatabase),
                    saveToFirebase('chatMessages', chatMessages),
                    saveToFirebase('settings', { nextReqId, nextUserId, nextMessageId })
                ]);
                
                lastSyncTime = new Date();
                updateStorageStatus();
                
            } catch (error) {
                console.error('🔄 Quiet sync error:', error);
            } finally {
                syncInProgress = false;
            }
        }

        async function forceSynchronization() {
            if (currentRole !== 'admin') {
                showNotification('Access denied. Admin privileges required.', 'error');
                return;
            }
            
            if (!isFirebaseConnected) {
                showNotification('Firestore not connected. Cannot synchronize.', 'error');
                return;
            }
            
            if (syncInProgress) {
                showNotification('Synchronization already in progress...', 'info');
                return;
            }
            
            const syncBtn = document.getElementById('sync-btn');
            const syncBtnText = document.getElementById('sync-btn-text');
            
            try {
                syncInProgress = true;
                syncBtn.disabled = true;
                syncBtnText.innerHTML = '<span class="loading-spinner"></span>Syncing...';
                updateStorageStatus();
                
                console.log('🔄 Force synchronization started...');
                
                // Comprehensive sync with progress tracking
                const startTime = Date.now();
                
                // Step 1: Save all local data to Firestore
                await Promise.all([
                    saveToFirebase('requisitions', requisitions),
                    saveToFirebase('users', userDatabase),
                    saveToFirebase('chatMessages', chatMessages),
                    saveToFirebase('settings', { nextReqId, nextUserId, nextMessageId })
                ]);
                
                // Step 2: Load fresh data from Firestore to ensure consistency
                const [freshRequisitions, freshUsers, freshChat, freshSettings] = await Promise.all([
                    loadFromFirebase('requisitions', []),
                    loadFromFirebase('users', userDatabase),
                    loadFromFirebase('chatMessages', {}),
                    loadFromFirebase('settings', { nextReqId, nextUserId, nextMessageId })
                ]);
                
                // Step 3: Update local data with fresh data
                if (freshRequisitions && freshRequisitions.length >= 0) {
                    requisitions.length = 0;
                    requisitions.push(...freshRequisitions);
                }
                
                if (freshUsers && Object.keys(freshUsers).length > 0) {
                    Object.keys(userDatabase).forEach(key => delete userDatabase[key]);
                    Object.assign(userDatabase, freshUsers);
                }
                
                if (freshChat) {
                    chatMessages = freshChat;
                }
                
                if (freshSettings) {
                    nextReqId = freshSettings.nextReqId || nextReqId;
                    nextUserId = freshSettings.nextUserId || nextUserId;
                    nextMessageId = freshSettings.nextMessageId || nextMessageId;
                }
                
                const syncDuration = Date.now() - startTime;
                lastSyncTime = new Date();
                
                // Update UI
                updateUI();
                updateStorageStatus();
                
                console.log(`✅ Force synchronization completed in ${syncDuration}ms`);
                showNotification(`Synchronization completed successfully! (${syncDuration}ms)`);
                
            } catch (error) {
                console.error('❌ Force synchronization error:', error);
                showNotification('Synchronization failed: ' + error.message, 'error');
            } finally {
                syncInProgress = false;
                syncBtn.disabled = false;
                syncBtnText.innerHTML = '🔄 Force Sync';
                updateStorageStatus();
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            
            if (diffSecs < 60) {
                return `${diffSecs}s ago`;
            } else if (diffMins < 60) {
                return `${diffMins}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else {
                const diffDays = Math.floor(diffHours / 24);
                return `${diffDays}d ago`;
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : type === 'info' ? 'info' : ''}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.user-dropdown')) {
                document.getElementById('dropdown-menu').classList.remove('open');
                document.getElementById('dropdown-arrow').classList.remove('open');
            }
        });

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = 'none';
                if (event.target.id === 'comment-modal') {
                    closeCommentModal();
                }
                if (event.target.id === 'rejection-modal') {
                    closeRejectionModal();
                }
                if (event.target.id === 'user-management-modal') {
                    closeUserManagement();
                }
                if (event.target.id === 'add-user-modal') {
                    closeAddUserModal();
                }
                if (event.target.id === 'chat-modal') {
                    closeChatModal();
                }
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9936a17de4d0739a',t:'MTc2MTI3OTA5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
